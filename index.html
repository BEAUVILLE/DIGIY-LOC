<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>DIGIY LOC ‚Äî Locations direct propri√©taire</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="description" content="Locations direct propri√©taire. 0% commission. Paiement direct. DIGIY LOC.">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#020617;
  --bg2:#0b1020;
  --card:#0b1220;
  --line:#1f2937;
  --ink:#f9fafb;
  --muted:#cbd5f5;
  --gold:#facc15;
  --gold2:#f97316;
  --green:#22c55e;
  --shadow:0 22px 55px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:
    radial-gradient(900px 520px at 10% -10%, rgba(250,204,21,.16), transparent 60%),
    radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
    linear-gradient(180deg, var(--bg2), var(--bg));
}
.wrap{max-width:1120px;margin:0 auto;padding:14px}
a{color:inherit;text-decoration:none}

.top{
  display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  padding:12px 12px;border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.03);
  box-shadow:var(--shadow);
}
.brand{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.logo{
  width:42px;height:42px;border-radius:14px;
  background:linear-gradient(135deg, rgba(250,204,21,.35), rgba(34,197,94,.2));
  border:1px solid rgba(250,204,21,.35);
  box-shadow:0 0 22px rgba(250,204,21,.12);
}
h1{margin:0;font-size:1.2rem}
.sub{color:var(--muted);font-weight:850;font-size:.95rem;margin-top:2px}
.btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{
  border:0; cursor:pointer;
  border-radius:14px;
  padding:11px 12px;
  font-weight:1000;
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  color:var(--muted);
}
.btn:hover{filter:brightness(1.08)}
.btn.primary{background:var(--green);border-color:rgba(34,197,94,.25);color:#022c22}
.btn.gold{background:rgba(250,204,21,.14);border-color:rgba(250,204,21,.35);color:#fde68a}

.filters{
  margin-top:14px;
  padding:12px;
  border:1px solid var(--line);
  border-radius:18px;
  background:rgba(255,255,255,.03);
  box-shadow:var(--shadow);
  display:grid;
  grid-template-columns: 1.2fr .8fr auto;
  gap:10px;
  align-items:end;
}
@media(max-width:840px){
  .filters{grid-template-columns:1fr}
}
label{display:block;font-size:.88rem;font-weight:950;color:#fff;margin:6px 0 6px}
input, select{
  width:100%;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  color:var(--ink);
  padding:11px 12px;
  font-weight:850;
  outline:none;
}
.note{
  margin-top:12px;
  padding:10px 12px;border-radius:14px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.03);
  color:var(--muted);
  white-space:pre-wrap;
}
.note.ok{border-color:rgba(34,197,94,.35);color:#bbf7d0;background:rgba(34,197,94,.09)}
.note.bad{border-color:rgba(239,68,68,.35);color:#fecaca;background:rgba(239,68,68,.09)}

.grid{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:14px;
}
.card{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:20px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
..thumb{
  width:100%;
  aspect-ratio: 4 / 3;
  object-fit: cover;
  object-position: center center;
  background:#020617;
}

.cardBody{padding:12px}
.title{
  font-size:1.08rem;
  font-weight:1100;
  margin:0;
}
.meta{color:var(--muted);font-weight:850;font-size:.93rem;margin-top:6px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.badge{
  border:1px solid rgba(148,163,184,.25);
  background:rgba(255,255,255,.02);
  color:var(--muted);
  font-weight:950;
  font-size:.82rem;
  padding:6px 9px;
  border-radius:999px;
}
.badge.gold{border-color:rgba(250,204,21,.35);background:rgba(250,204,21,.10);color:#fde68a}
.price{
  margin-top:10px;
  font-weight:1200;
  color:#fff;
  font-size:1.02rem;
}
.actions{
  display:flex;gap:10px;flex-wrap:wrap;
  padding:12px;
  border-top:1px solid rgba(148,163,184,.18);
}
.linkBtn{
  flex:1;
  text-align:center;
  border-radius:14px;
  padding:11px 12px;
  font-weight:1100;
  border:1px solid var(--line);
  background:rgba(255,255,255,.02);
  color:var(--muted);
}
.linkBtn.primary{
  background:var(--green);
  color:#022c22;
  border-color:rgba(34,197,94,.25);
}
footer{
  padding:18px 10px 30px;
  text-align:center;
  color:var(--muted);
  font-weight:850;
  font-size:.86rem;
}
.smallTip{color:var(--muted);font-weight:850;font-size:.9rem;margin-top:6px}
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>üè° DIGIY LOC</h1>
        <div class="sub">Locations direct propri√©taire ‚Äî 0% commission ‚Äî paiement direct</div>
      </div>
    </div>
    <div class="btnRow">
      <a class="btn gold" href="pro-loc.html">‚≠ê Espace PRO</a>
      <a class="btn primary" href="https://wa.me/221771342889?text=Bonjour%20DIGIY%20LOC%2C%20je%20veux%20publier%20mon%20logement." target="_blank" rel="noopener">üì© Publier mon logement</a>
    </div>
  </div>

  <div class="filters">
    <div>
      <label>Recherche</label>
      <input id="q" placeholder="ex: villa, appartement, CHEZ BAPTISTE..." />
      <div class="smallTip">Astuce : tape juste ‚ÄúSaly‚Äù ou le nom du logement.</div>
    </div>
    <div>
      <label>Ville</label>
      <select id="city">
        <option value="">Toutes</option>
      </select>
    </div>
    <div>
      <button class="btn primary" id="btnSearch" style="width:100%">üîé Filtrer</button>
    </div>
  </div>

  <div class="note" id="status">Chargement‚Ä¶</div>
  <div class="grid" id="grid"></div>

  <footer>¬© DIGIY LOC ‚Äî Direct propri√©taire ‚Ä¢ 0% commission</footer>
</div>

<script>
/* =========================
   SUPABASE
========================= */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   DOM
========================= */
const statusEl = document.getElementById("status");
const gridEl   = document.getElementById("grid");
const qEl      = document.getElementById("q");
const cityEl   = document.getElementById("city");
const btnSearch= document.getElementById("btnSearch");

const FALLBACK_PHOTO = "https://digiylyfe.com/wp-content/uploads/2025/06/042-BAPTISTE.png";

function setStatus(msg, type){
  statusEl.classList.remove("ok","bad");
  if(type) statusEl.classList.add(type);
  statusEl.textContent = msg;
}
function money(n){
  const v = Number(n||0);
  return v.toLocaleString("fr-FR") + " FCFA";
}
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normalizeStatus(s){
  const v = String(s||"").toLowerCase().trim();
  if(["actif","active","published","online"].includes(v)) return "actif";
  return v || "brouillon";
}

function matchesSearch(row, q){
  if(!q) return true;
  const hay = [
    row.nom, row.ville, row.adresse, row.description
  ].filter(Boolean).join(" ").toLowerCase();
  return hay.includes(q.toLowerCase());
}

let allRows = [];

function render(rows){
  gridEl.innerHTML = "";
  if(!rows || rows.length===0){
    setStatus("Aucun logement disponible pour le moment.", "ok");
    return;
  }
  setStatus(`${rows.length} logement(s) disponible(s).`, "ok");

  rows.forEach(l=>{
    const img = (l.photo_url && String(l.photo_url).startsWith("http")) ? l.photo_url : FALLBACK_PHOTO;
    const ville = l.ville || "‚Äî";
    const adr = l.adresse ? " ‚Ä¢ " + l.adresse : "";
    const prix = money(l.prix_nuit);

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <img class="thumb" loading="lazy" src="${esc(img)}" alt="${esc(l.nom || "Logement")}">
      <div class="cardBody">
        <h3 class="title">${esc(l.nom || "Logement")}</h3>
        <div class="meta">${esc(ville)}${esc(adr)}</div>

        <div class="badges">
          <span class="badge gold">0% commission</span>
          <span class="badge">Direct propri√©taire</span>
        </div>

        <div class="price">üí∞ ${prix} / nuit</div>
      </div>
      <div class="actions">
        <a class="linkBtn primary" href="loc.html?id=${encodeURIComponent(l.id)}">Voir la fiche</a>
        <a class="linkBtn" href="https://wa.me/${encodeURIComponent(String(l.proprietaire_phone||'').replace(/[^\d]/g,''))}?text=Bonjour%20je%20viens%20de%20voir%20${encodeURIComponent(l.nom||'votre logement')}%20sur%20DIGIY%20LOC." target="_blank" rel="noopener">WhatsApp</a>
      </div>
    `;
    gridEl.appendChild(div);
  });
}

function rebuildCities(rows){
  const cities = Array.from(new Set((rows||[]).map(r=>String(r.ville||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  cityEl.innerHTML = `<option value="">Toutes</option>` + cities.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
}

function applyFilters(){
  const q = qEl.value.trim();
  const c = cityEl.value.trim().toLowerCase();

  const filtered = allRows.filter(r=>{
    if(c && String(r.ville||"").trim().toLowerCase() !== c) return false;
    if(!matchesSearch(r, q)) return false;
    return true;
  });

  render(filtered);
}

btnSearch.addEventListener("click", applyFilters);
qEl.addEventListener("input", ()=>{ window.clearTimeout(window.__t); window.__t = setTimeout(applyFilters, 180); });
cityEl.addEventListener("change", applyFilters);

(async function load(){
  try{
    setStatus("Chargement des logements‚Ä¶");

    // IMPORTANT: ton status = "actif" (vu dans tes rows). Donc on filtre intelligemment.
    const { data, error } = await SB
      .from("digiy_logements")
      .select("id,nom,ville,adresse,description,photo_url,prix_nuit,status,created_at,proprietaire_phone")
      .order("created_at", { ascending:false })
      .limit(80);

    if(error){
      console.error(error);
      setStatus("Erreur Supabase:\n" + (error.message || JSON.stringify(error)), "bad");
      return;
    }

    const rows = (data || []).filter(r => normalizeStatus(r.status) === "actif");

    allRows = rows;
    rebuildCities(allRows);
    render(allRows);
  }catch(e){
    console.error(e);
    setStatus("Erreur JS:\n" + (e.message || e), "bad");
  }
})();
</script>
</body>
</html>
