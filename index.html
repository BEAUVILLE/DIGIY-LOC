<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>DIGIY LOC ‚Äî Galerie des logements partenaires</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="DIGIY LOC ‚Äî Locations direct propri√©taire, paiement direct, 0% commission.">
  <meta name="theme-color" content="#020617">

  <style>
    :root{
      --bg:#020617;
      --bg-soft:#020818;
      --card:#030712;
      --accent:#facc15;
      --accent-soft:#f97316;
      --accent-green:#22c55e;
      --ink:#f9fafb;
      --muted:#cbd5f5;
      --line:rgba(148,163,184,0.22);
      --shadow-soft:0 20px 45px rgba(15,23,42,0.9);
      --glass:rgba(2,6,23,.68);
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif}
    body{
      min-height:100vh;
      background:
        radial-gradient(circle at top,rgba(250,204,21,0.16),transparent 60%),
        radial-gradient(circle at bottom,rgba(34,197,94,0.16),transparent 55%),
        var(--bg);
      color:var(--ink);
      display:flex;
      justify-content:center;
      padding:10px;
      font-size:16px;
    }

    .app{
      width:100%;
      max-width:1100px;
      min-height:100vh;
      background:linear-gradient(135deg,#020617 0%,#020818 50%,#020617 100%);
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:var(--shadow-soft);
      padding:16px 16px 22px;
      display:flex;
      flex-direction:column;
      position:relative;
      overflow:hidden;
    }

    .app::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0% 0%,rgba(250,204,21,0.14),transparent 55%),
        radial-gradient(circle at 100% 100%,rgba(34,197,94,0.14),transparent 45%);
      opacity:0.8;
      pointer-events:none;
    }

    header{
      position:relative;
      z-index:2;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }

    .brand{display:flex;align-items:center;gap:10px}
    .brand-logo{
      width:42px;height:42px;border-radius:14px;
      background:radial-gradient(circle at 30% 0%,#facc15,#f97316);
      display:flex;align-items:center;justify-content:center;
      font-size:24px;
      box-shadow:0 12px 30px rgba(234,179,8,0.65);
    }
    .brand-text-title{
      font-size:20px;font-weight:900;letter-spacing:0.09em;
      text-transform:uppercase;color:var(--accent-green);
    }
    .brand-text-sub{font-size:14px;color:var(--muted);font-weight:650}

    .back-link{
      font-size:13px;color:var(--muted);text-decoration:none;
      background:rgba(15,23,42,0.9);
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      padding:8px 14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:800;
      white-space:nowrap;
    }
    .back-link:hover{border-color:var(--accent);color:var(--accent)}

    .hero{
      background:radial-gradient(circle at top left,rgba(34,197,94,0.18),rgba(3,7,18,0.96));
      border-radius:22px;
      border:1px solid rgba(148,163,184,0.6);
      padding:16px;
      box-shadow:0 18px 44px rgba(15,23,42,0.95);
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      z-index:2;
    }
    .hero-title{
      font-size:26px;font-weight:950;color:var(--accent-green);
      line-height:1.15;
    }
    .hero-title span{color:var(--accent)}
    .hero-sub{
      font-size:16px;color:#e5e7eb;max-width:760px;
      font-weight:500;line-height:1.6;
    }
    .hero-tags{display:flex;flex-wrap:wrap;gap:7px;margin-top:4px}
    .hero-tag{
      font-size:13px;padding:5px 11px;border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.95);
      color:#e5e7eb;font-weight:650;
    }
    .hero-tag strong{color:var(--accent)}

    .cta-row{
      margin-top:14px;
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:10px;
      position:relative;
      z-index:2;
    }
    .cta-btn{
      background:linear-gradient(135deg,#facc15,#f97316);
      padding:12px 18px;border-radius:999px;
      color:#111;font-size:14px;font-weight:950;text-decoration:none;
      box-shadow:0 8px 20px rgba(250,204,21,0.45);
      border:1px solid rgba(250,204,21,0.65);
      transition:transform .2s ease, box-shadow .2s ease;
      display:inline-flex;align-items:center;gap:8px;
      cursor:pointer;
    }
    .cta-btn:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(250,204,21,0.65)}
    .cta-btn.secondary{
      background:rgba(22,163,74,0.16);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,0.8);
      box-shadow:none;
    }
    .cta-btn.secondary:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(34,197,94,0.18)}
    .cta-btn.nd{
      background:rgba(250,204,21,0.12);
      color:#fde68a;
      border:1px solid rgba(250,204,21,0.55);
      box-shadow:none;
    }

    .filters{
      margin-top:14px;
      display:grid;
      grid-template-columns:1.25fr 1fr auto auto;
      gap:10px;
      position:relative;
      z-index:2;
    }
    input,select{
      padding:11px 12px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(2,6,23,0.85);
      color:var(--ink);
      outline:none;
      font-weight:800;
    }
    button{
      padding:11px 14px;border-radius:14px;border:none;
      background:linear-gradient(135deg,#facc15,#f97316);
      font-weight:950;cursor:pointer;color:#111;
      box-shadow:0 10px 22px rgba(250,204,21,0.25);
      white-space:nowrap;
    }
    .ghost{
      background:rgba(15,23,42,0.75);
      color:#e5e7eb;
      border:1px solid var(--line);
      box-shadow:none;
    }
    @media(max-width:900px){.filters{grid-template-columns:1fr 1fr}}
    @media(max-width:640px){
      body{padding:0}
      .app{border-radius:0;border:none;box-shadow:none;padding:12px 12px 18px}
      .brand-text-title{font-size:18px}
      .hero-title{font-size:22px}
    }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:16px;
      position:relative;
      z-index:2;
    }
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}

    .card{
      background:radial-gradient(circle at top,rgba(15,23,42,0.98),#020617);
      border-radius:24px;
      border:1px solid rgba(30,64,175,0.7);
      padding:12px;
      box-shadow:0 14px 34px rgba(15,23,42,0.95);
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .photo{
      height:220px;
      border-radius:16px;
      overflow:hidden;
      border:2px solid rgba(30,64,175,0.85);
      background:#0b1220;
    }
    .photo img{width:100%;height:100%;object-fit:cover;display:block}

    .name{font-size:22px;font-weight:950;color:var(--accent);line-height:1.1}
    .type{font-size:15px;color:#e5e7eb;font-weight:800}

    .badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      width:max-content;padding:5px 9px;font-size:12px;border-radius:999px;
      border:1px solid rgba(34,197,94,0.9);
      color:var(--accent-green);
      background:rgba(15,23,42,0.98);
      font-weight:950;
      white-space:nowrap;
    }
    .badge.gold{
      border-color:rgba(250,204,21,0.9);
      color:var(--accent);
    }
    .badge.free{
      border-color:rgba(34,197,94,0.95);
      color:#bbf7d0;
      background:rgba(6,78,59,0.65);
    }
    .badge.busy{
      border-color:rgba(248,113,113,0.95);
      color:#fecaca;
      background:rgba(127,29,29,0.55);
    }

    .ndimbalBox{
      margin-top:6px;
      border-radius:16px;
      border:1px solid rgba(250,204,21,0.55);
      background:rgba(250,204,21,0.08);
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .ndTitle{font-size:13px;font-weight:950;color:#fde68a}
    .ndLine{font-size:14px;font-weight:850;color:#fff;line-height:1.45}
    .ndSmall{font-size:12px;color:#e5e7eb;opacity:.95}

    .desc{font-size:15px;color:#f3f4f6;line-height:1.6;font-weight:550}
    .meta{font-size:14px;color:#e5e7eb;font-weight:750;opacity:0.95}

    .contact{
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(34,197,94,1);
      background:rgba(6,78,59,0.98);
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .contact-title{font-size:14px;font-weight:950;color:#bbf7d0}
    .contact-value{font-size:18px;font-weight:950;color:#ecfdf5;letter-spacing:0.2px}

    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;border-radius:999px;padding:10px 14px;
      font-size:14px;font-weight:950;cursor:pointer;
      display:flex;justify-content:center;align-items:center;
      text-decoration:none;transition:transform .18s ease;
      flex:1;min-height:44px;white-space:nowrap;
      touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn-primary{
      background:linear-gradient(135deg,#facc15,#f97316);
      color:#111;
      box-shadow:0 7px 18px rgba(250,204,21,0.55);
    }
    .btn-wa{
      background:rgba(22,163,74,0.2);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,0.85);
    }
    .btn-ghost{
      background:rgba(15,23,42,0.75);
      color:#e5e7eb;
      border:1px solid var(--line);
    }
    .btn-nd{
      background:rgba(250,204,21,0.12);
      color:#fde68a;
      border:1px solid rgba(250,204,21,0.55);
    }

    .bigmsg{
      grid-column:1/-1;
      background:rgba(2,6,23,0.72);
      border:1px solid rgba(148,163,184,0.25);
      padding:14px;
      border-radius:18px;
      font-weight:900;
      color:#e5e7eb;
      line-height:1.55;
    }
    .bigmsg b{color:var(--accent)}

    footer{
      margin-top:20px;
      font-size:12px;
      color:var(--muted);
      font-weight:750;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:6px;
      position:relative;
      z-index:2;
    }
    footer span{color:var(--accent);font-weight:950}

    /* =========================
       NDIMBAL OVERLAY (PAGE INTEGREE)
    ========================= */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .overlay.show{display:flex}
    .panel{
      width:100%;
      max-width:860px;
      border-radius:22px;
      border:1px solid rgba(148,163,184,.35);
      background:linear-gradient(135deg, rgba(2,6,23,.92), rgba(2,8,24,.92));
      box-shadow:0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
    }
    .panelTop{
      padding:16px;
      background:
        radial-gradient(circle at 0% 0%, rgba(250,204,21,.18), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(34,197,94,.14), transparent 50%),
        rgba(2,6,23,.6);
      border-bottom:1px solid rgba(148,163,184,.28);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .panelTitle{
      font-size:18px;font-weight:950;color:#fde68a;
      letter-spacing:.02em;
    }
    .panelSub{
      margin-top:6px;
      font-size:14px;
      color:#e5e7eb;
      font-weight:650;
      line-height:1.55;
      max-width:640px;
    }
    .panelClose{
      background:rgba(15,23,42,.75);
      border:1px solid rgba(148,163,184,.28);
      color:#e5e7eb;
      border-radius:999px;
      padding:8px 12px;
      font-weight:950;
      cursor:pointer;
      white-space:nowrap;
    }
    .panelBody{
      padding:16px;
      display:grid;
      grid-template-columns:1.2fr .8fr;
      gap:14px;
    }
    @media(max-width:820px){.panelBody{grid-template-columns:1fr}}
    .box{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.55);
      border-radius:18px;
      padding:14px;
    }
    .kicker{
      font-size:12px;
      font-weight:950;
      color:#bbf7d0;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.95;
    }
    .big{
      margin-top:6px;
      font-size:22px;
      font-weight:950;
      line-height:1.15;
      color:#facc15;
    }
    .txt{
      margin-top:10px;
      font-size:14px;
      color:#e5e7eb;
      line-height:1.7;
      font-weight:650;
    }
    .bul{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:14px;
      color:#e5e7eb;
      font-weight:650;
      line-height:1.55;
    }
    .bul div{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.35);
    }
    .hi{color:#fde68a;font-weight:950}
    .panelActions{
      padding:14px 16px;
      border-top:1px solid rgba(148,163,184,.22);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      background:rgba(2,6,23,.55);
    }
    .pbtn{
      border-radius:999px;
      padding:10px 14px;
      font-weight:950;
      cursor:pointer;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
    }
    .pbtn.gold{
      border-color:rgba(250,204,21,.55);
      background:rgba(250,204,21,.12);
      color:#fde68a;
    }
    .pbtn.green{
      border-color:rgba(34,197,94,.55);
      background:rgba(34,197,94,.12);
      color:#bbf7d0;
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="brand-logo">üè†</div>
        <div>
          <div class="brand-text-title">DIGIY LOC</div>
          <div class="brand-text-sub">Galerie des logements partenaires</div>
        </div>
      </div>

      <a href="https://beauville.github.io/digiy-hub/" class="back-link">
        <span>‚Üê</span> Retour DIGIY HUB
      </a>
    </header>

    <main>
      <section class="hero">
        <div class="hero-title">Locations direct propri√©taire <span>0% commission</span></div>
        <div class="hero-sub">
          Paiement direct (Wave/esp√®ces selon le logement). DIGIY ne touche pas l‚Äôargent : <b>0% commission</b>.
          <br><br>
          üåô <b>NDIMBAL</b> = des <b>nuits offertes</b> (Lun‚ÜíJeu) pour te faire rester +1 nuit ‚Äî et faire vivre le quartier.
        </div>
        <div class="hero-tags">
          <div class="hero-tag"><strong>Direct propri√©taire</strong> ‚Äî pas d‚Äôinterm√©diaire</div>
          <div class="hero-tag">Saly ‚Ä¢ Dakar ‚Ä¢ Mbour ‚Ä¢ Thi√®s</div>
          <div class="hero-tag">WhatsApp en 1 clic</div>
          <div class="hero-tag"><strong>Live</strong> : dispo du jour</div>
          <div class="hero-tag"><strong>NDIMBAL</strong> : nuits offertes (Lun-Jeu)</div>
        </div>
      </section>

      <section class="cta-row">
        <a href="https://beauville.github.io/inscription-digiy/?module=loc" class="cta-btn" target="_blank" rel="noopener noreferrer">
          üè† Publier mon logement ‚Ä¢ 0% commission
        </a>
        <button class="cta-btn nd" type="button" id="btnNdOpenTop">
          üåô Comprendre NDIMBAL
        </button>
        <a href="https://wa.me/221771342889" class="cta-btn secondary" target="_blank" rel="noopener noreferrer">
          üì≤ Parler √† l‚Äô√©quipe DIGIY
        </a>
      </section>

      <section class="filters">
        <input id="q" placeholder="Zone (Saly, Dakar, Mbour...)" autocomplete="off">
        <select id="kind">
          <option value="">Type : Tout</option>
          <option value="villa">Villa</option>
          <option value="appartement">Appartement</option>
          <option value="studio">Studio</option>
          <option value="chambre">Chambre</option>
        </select>
        <button id="btnSearch">üîé Chercher</button>
        <button id="btnReset" class="ghost" type="button">‚Ü©Ô∏é Reset</button>
      </section>

      <section id="grid" class="grid"></section>
    </main>

    <footer>
      <div>DIGIY LOC ‚Ä¢ <span>Super App DIGIYLYFE</span> ‚Äî S√©n√©gal ‚Üí Afrique</div>
      <div>0% commission ‚Ä¢ Paiement direct ‚Ä¢ Galerie √©volutive</div>
    </footer>
  </div>

  <!-- =========================
       NDIMBAL OVERLAY PAGE
  ========================== -->
  <div class="overlay" id="ndOverlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Comprendre NDIMBAL">
      <div class="panelTop">
        <div>
          <div class="panelTitle">üåô NDIMBAL ‚Äî le pouvoir des nuits offertes</div>
          <div class="panelSub">
            NDIMBAL n‚Äôest pas ‚Äúune commission‚Äù ni ‚Äúun frais‚Äù.
            C‚Äôest une strat√©gie locale : <b>tu restes +1 nuit</b> ‚Üí tu <b>consommes +1 jour</b> dans le quartier (restos, taxis, march√©, plage‚Ä¶).
            C‚Äôest √ßa les retomb√©es.
          </div>
        </div>
        <button class="panelClose" type="button" id="ndClose">‚úï Fermer</button>
      </div>

      <div class="panelBody">
        <div class="box">
          <div class="kicker">OFFRE OFFICIELLE</div>
          <div class="big">2 nuits pay√©es = 3·µâ offerte</div>
          <div class="txt">
            Valable <span class="hi">du lundi au jeudi</span> (selon disponibilit√© du logement NDIMBAL).
            Objectif : pousser les s√©jours en semaine et faire tourner l‚Äô√©conomie du quartier.
          </div>

          <div class="bul">
            <div>‚úÖ Tu gagnes <span class="hi">1 nuit</span> ‚Üí tu restes plus longtemps.</div>
            <div>‚úÖ Tu d√©penses <span class="hi">1 jour de plus</span> dans le coin ‚Üí le quartier gagne.</div>
            <div>‚úÖ Le logement gagne en <span class="hi">bouche-√†-oreille</span> (la com est foudroyante).</div>
          </div>
        </div>

        <div class="box">
          <div class="kicker">COMMENT REP√âRER ?</div>
          <div class="txt">
            Dans la galerie, un logement NDIMBAL porte un badge <span class="hi">üåô NDIMBAL</span>.
            Exemple : <span class="hi">CHEZ ASTOU SALY</span>.
          </div>
          <div class="bul">
            <div>1) Tu choisis tes dates.</div>
            <div>2) Tu √©cris au proprio via WhatsApp.</div>
            <div>3) Tu dis : <span class="hi">‚ÄúJe veux profiter de NDIMBAL‚Äù</span>.</div>
          </div>
        </div>
      </div>

      <div class="panelActions">
        <button class="pbtn gold" type="button" id="ndClose2">‚úÖ J‚Äôai compris</button>
        <button class="pbtn green" type="button" id="ndTalk">üì≤ Parler √† DIGIY</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* =========================
       SUPABASE
    ========================= */
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const grid = document.getElementById("grid");

    /* =========================
       CONTACT OFFICIEL
    ========================= */
    const TEAM_WA = "+221771342889";

    /* =========================
       NDIMBAL (R√àGLE + LOGEMENT OFFICIEL)
       -> on d√©clenche NDIMBAL par TITRE (simple, terrain)
    ========================= */
    const NDIMBAL_NAME = "CHEZ ASTOU SALY";
    const NDIMBAL_RULE = "2 nuits pay√©es = 3e offerte (Lun-Jeu)";

    function isNdimbal(row){
      return (String(row.title || "").toUpperCase().trim() === NDIMBAL_NAME);
    }

    /* =========================
       ASTOU ‚Äî FORC√â DANS LA GALERIE (m√™me si Supabase ne renvoie rien)
    ========================= */
    const ASTOU_PIN = {
      title: "CHEZ ASTOU SALY",
      slug: "chez-astou-saly",
      address_label: "Saly",
      kind: "Location ‚Ä¢ Direct propri√©taire",
      whatsapp: "+221778765785",
      cover: "https://digiylyfe.com/wp-content/uploads/2025/06/042-BAPTISTE.png",
      desc: "Logement partenaire NDIMBAL : nuits offertes en semaine pour prolonger le s√©jour."
    };

    /* =========================
       PLACEBOTS (garniture)
    ========================= */
    const PLACEBOTS = [
      { title:"Zone Dakar ‚Äî ouverture progressive", slug:"zone-dakar-en-ouverture", address_label:"Dakar", kind:"Appartement ‚Ä¢ Studio", whatsapp:TEAM_WA,
        cover:"https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?auto=format&fit=crop&w=1400&q=80",
        desc:"On ouvre quartier par quartier. Dis ta zone + budget, l‚Äô√©quipe te propose."
      },
      { title:"Zone Somone / Ngaparou ‚Äî bons plans", slug:"zone-somone-bons-plans", address_label:"Somone", kind:"Studio ‚Ä¢ Villa", whatsapp:TEAM_WA,
        cover:"https://images.unsplash.com/photo-1445019980597-93fa8acb246c?auto=format&fit=crop&w=1400&q=80",
        desc:"Tu veux un bon plan ? Envoie dates + budget, on te guide."
      },
      { title:"Mbour ‚Äî logements partenaires √† venir", slug:"zone-mbour-a-venir", address_label:"Mbour", kind:"Villa ‚Ä¢ Chambre", whatsapp:TEAM_WA,
        cover:"https://images.unsplash.com/photo-1512918728675-ed5a9ecdebfd?auto=format&fit=crop&w=1400&q=80",
        desc:"Tu cherches sur Mbour ? On active les proprios. Contacte-nous."
      },
      { title:"Thi√®s ‚Äî ouverture en cours", slug:"zone-thies-a-venir", address_label:"Thi√®s", kind:"Studio ‚Ä¢ Appartement", whatsapp:TEAM_WA,
        cover:"https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=1400&q=80",
        desc:"Thi√®s arrive. Envoie ta zone, on te r√©pond vite."
      },
      { title:"Toubab Dialaw ‚Äî week-end & chill", slug:"zone-toubab-dialaw-weekend", address_label:"Toubab Dialaw", kind:"Villa ‚Ä¢ Studio", whatsapp:TEAM_WA,
        cover:"https://images.unsplash.com/photo-1520250497591-112f2f40a3f4?auto=format&fit=crop&w=1400&q=80",
        desc:"Week-end au calme ? On te trouve une option selon ton budget."
      },
      { title:"Saly ‚Äî nouveaux logements en cours", slug:"zone-saly-en-ouverture", address_label:"Saly", kind:"Villa ‚Ä¢ Appartement ‚Ä¢ Studio", whatsapp:TEAM_WA,
        cover:"https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&w=1400&q=80",
        desc:"Les nouveaux logements arrivent. √âcris-nous pour √™tre notifi√© d√®s qu‚Äôun logement est publi√©."
      }
    ];

    /* =========================
       DISPONIBILIT√â ‚Äî VIEW
    ========================= */
    const OCCUPANCY_VIEW = "v_loc_pin_occupancy_today";

    /* =========================
       HELPERS
    ========================= */
    function openWa(phone, message){
      const txt = encodeURIComponent(message || "");
      const digits = String(phone || "").replace(/\D/g, "");
      const url = "https://wa.me/" + digits + (txt ? "?text=" + txt : "");
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function norm(s){ return String(s || "").trim().toLowerCase(); }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){ return escapeHtml(str).replaceAll("`","&#096;"); }
    function escapeJs(str){
      return String(str ?? "")
        .replaceAll("\\","\\\\")
        .replaceAll("'","\\'")
        .replaceAll('"','\\"')
        .replaceAll("\n"," ")
        .replaceAll("\r"," ");
    }

    function mergeNoDup(baseList, fillers, targetCount){
      const merged = [...baseList];
      const seen = new Set(baseList.map(x => String(x.slug || "").toLowerCase()).filter(Boolean));
      for (const f of fillers){
        if (merged.length >= targetCount) break;
        const s = String(f.slug || "").toLowerCase();
        if (s && seen.has(s)) continue;
        merged.push(f);
        if (s) seen.add(s);
      }
      return merged;
    }

    function computeKind(row){
      const t = norm(row.title || "");
      if (t.includes("villa")) return "Villa ‚Ä¢ Direct propri√©taire";
      if (t.includes("studio")) return "Studio ‚Ä¢ Direct propri√©taire";
      if (t.includes("appart")) return "Appartement ‚Ä¢ Direct propri√©taire";
      return "Location ‚Ä¢ Direct propri√©taire";
    }

    function pickWhatsApp(row){
  const slug = String(row.slug || "").toLowerCase();
  const title = String(row.title || "").toUpperCase();

  /* üîí FOR√áAGE ABSOLU ASTOU */
  if (slug === "chez-astou-saly" || title.includes("CHEZ ASTOU SALY")){
    return "+221778765785";
  }

  const wa = row.whatsapp || row.phone || "";
  const digits = String(wa).replace(/\D/g, "");
  if (digits.length >= 9) return wa;

  return TEAM_WA;
}

    function pickCover(row){
      return (
        row.cover ||
        "https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?auto=format&fit=crop&w=1400&q=80"
      );
    }

    function pinLink(slug){
      if (!slug) return "https://beauville.github.io/digiy-loc-pro/";
      return "https://beauville.github.io/digiy-loc-pro/go-pin.html?slug=" + encodeURIComponent(slug);
    }

    /* =========================
       NDIMBAL OVERLAY CONTROL
    ========================= */
    const ndOverlay = document.getElementById("ndOverlay");
    const ndClose = document.getElementById("ndClose");
    const ndClose2 = document.getElementById("ndClose2");
    const ndTalk = document.getElementById("ndTalk");
    const btnNdOpenTop = document.getElementById("btnNdOpenTop");

    function openNdimbal(){
      ndOverlay.classList.add("show");
      ndOverlay.setAttribute("aria-hidden","false");
    }
    function closeNdimbal(){
      ndOverlay.classList.remove("show");
      ndOverlay.setAttribute("aria-hidden","true");
    }

    btnNdOpenTop.addEventListener("click", openNdimbal);
    ndClose.addEventListener("click", closeNdimbal);
    ndClose2.addEventListener("click", closeNdimbal);
    ndOverlay.addEventListener("click", (e)=>{ if (e.target === ndOverlay) closeNdimbal(); });
    document.addEventListener("keydown",(e)=>{ if (e.key === "Escape") closeNdimbal(); });

    ndTalk.addEventListener("click", ()=>{
      openWa(TEAM_WA, `Bonjour DIGIY üëã\nJe veux en savoir plus sur NDIMBAL (${NDIMBAL_RULE}).`);
    });

    /* =========================
       LOGGING (best-effort)
    ========================= */
    async function logReservationIntent(pin){
      try{
        await sb.from("loc_reservation_requests").insert({
          pin_slug: pin.slug || null,
          logement_title: pin.title || null,
          owner_phone: pickWhatsApp(pin) || null
        });
      }catch(e){
        console.warn("[DIGIY LOC] logReservationIntent ignored:", e?.message || e);
      }
    }

    async function reserveNow(pin){
      const wa = pickWhatsApp(pin);
      const title = pin.title || "ce logement";
      const nd = isNdimbal(pin);
      const ndLine = nd
        ? `\n\nüåô NDIMBAL : ${NDIMBAL_RULE}\nJe veux en profiter si dispo (Lun-Jeu).`
        : "";
      const msg = `Bonjour, je souhaite r√©server / avoir des infos pour "${title}" via DIGIY LOC.${ndLine}`;
      await logReservationIntent(pin);
      openWa(wa, msg);
    }

    async function fetchOccupancyToday(){
      const { data, error } = await sb
        .from(OCCUPANCY_VIEW)
        .select("pin_slug,is_occupied_today");

      if (error) {
        console.warn("[DIGIY LOC] occupancy view error:", error.message);
        return new Map();
      }

      const m = new Map();
      (data || []).forEach(r=>{
        if (r && r.pin_slug) m.set(String(r.pin_slug), !!r.is_occupied_today);
      });
      return m;
    }

    function cardTemplate(p, occMap){
      const title = p.title || "Logement";
      const slug  = p.slug || "";
      const city  = p.address_label || "‚Äî";
      const kind  = p.kind || computeKind(p);
      const wa    = pickWhatsApp(p);
      const cover = pickCover(p);

      const isOccupied = occMap ? (occMap.get(slug) === true) : false;
      const nd = isNdimbal(p);

      const badges = [];
      badges.push(`<div class="badge">0% com DIGIY</div>`);
      badges.push(isOccupied
        ? `<div class="badge busy">‚õî OCCUP√â aujourd‚Äôhui</div>`
        : `<div class="badge free">‚úÖ DISPONIBLE</div>`
      );
      if (nd) badges.push(`<div class="badge gold">üåô NDIMBAL ‚Ä¢ Nuits offertes</div>`);

      const ndBox = nd ? `
        <div class="ndimbalBox">
          <div class="ndTitle">üåô Offre NDIMBAL (CHEZ ASTOU)</div>
          <div class="ndLine"><b>${escapeHtml(NDIMBAL_RULE)}</b></div>
          <div class="ndSmall">Tu restes +1 nuit ‚Üí tu consommes +1 jour dans le quartier (retomb√©es √©normes).</div>
        </div>
      ` : `
        <div class="ndimbalBox">
          <div class="ndTitle">üåô NDIMBAL (infos)</div>
          <div class="ndLine">Comprendre le r√¥le de NDIMBAL (nuits offertes + √©conomie quartier).</div>
          <div class="ndSmall">Clique ‚Äúüåô Comprendre NDIMBAL‚Äù.</div>
        </div>
      `;

      return `
        <article class="card">
          <div class="photo">
            <img
              alt="${escapeHtml(title)}"
              src="${escapeAttr(cover)}"
              onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?auto=format&fit=crop&w=1400&q=80';"
            >
          </div>

          <div class="name">${escapeHtml(title)}</div>
          <div class="type">${escapeHtml(kind)} ‚Ä¢ ${escapeHtml(city)}</div>

          <div class="badges">${badges.join("")}</div>

          ${ndBox}

          <p class="desc">
            ${escapeHtml(p.desc || "Contact direct propri√©taire. Paiement direct (Wave/esp√®ces selon le logement). 0% commission.")}
          </p>

          <div class="meta">WhatsApp direct ‚Ä¢ R√©ponse rapide</div>

          <div class="contact">
            <div class="contact-title">Contact (WhatsApp)</div>
            <div class="contact-value">${escapeHtml(wa)}</div>
          </div>

          <div class="actions">
            <a class="btn btn-primary" href="${pinLink(slug)}" target="_blank" rel="noopener noreferrer">üëÄ Voir le PIN</a>
            <button class="btn btn-wa" type="button" onclick='reserveNow(${JSON.stringify({
              slug: slug,
              title: title,
              whatsapp: p.whatsapp || "",
              phone: p.phone || "",
              address_label: city,
              cover: cover,
              kind: kind,
              desc: p.desc || ""
            }).replace(/</g,"\\u003c")})'>üì≤ R√©server (WhatsApp)</button>
          </div>

          <div class="actions">
            <button class="btn btn-nd" type="button" onclick="openNdimbal()">
PIN</a>
            <button class="btn btn-wa" type="button" onclick='reserveNow(${JSON.stringify({
              slug: slug,
              title: title,
              whatsapp: p.whatsapp || "",
              phone: p.phone || "",
              address_label: city,
              cover: cover,
              kind: kind,
              desc: p.desc || ""
            }).replace(/</g,"\\u003c")})'>üì≤ R√©server (WhatsApp)</button>
          </div>

          <div class="actions">
            <button class="btn btn-nd" type="button" onclick="openNdimbal()">              üåô NDIMBAL ‚Äî Comprendre
            </button>
          </div>
        </article>
      `;
    }

    function applyFilters(list){
      const q = norm(document.getElementById("q").value);
      const kind = norm(document.getElementById("kind").value);

      return list.filter(p=>{
        const title = norm(p.title || "");
        const city  = norm(p.address_label || "");
        const k     = norm(p.kind || computeKind(p));

        if (q && !(title.includes(q) || city.includes(q))) return false;
        if (kind && !k.includes(kind)) return false;
        return true;
      });
    }

    /* =========================
       FETCH go_pins (LOC)
    ========================= */
    async function fetchLocPins(){
      const { data, error } = await sb
        .from("go_pins")
        .select("*")
        .eq("category", "loc")
        .eq("is_public", true)
        .eq("is_active", true)
        .order("featured_rank", { ascending: true })
        .order("created_at", { ascending: false });

      if (error) {
        console.warn("[DIGIY LOC] Supabase error:", error.message);
        return { ok:false, rows:[], error: error.message };
      }
      return { ok:true, rows: Array.isArray(data) ? data : [], error:null };
    }

    /* =========================
       NDIMBAL ‚Äî MODAL (PAGE EXPLICATIVE)
       => z√©ro renvoi externe, c‚Äôest ici que √ßa parle
    ========================= */
    function openNdimbal(){
      const m = document.getElementById("ndModal");
      if (!m) return;
      m.classList.add("show");
      document.body.style.overflow = "hidden";
    }
    function closeNdimbal(){
      const m = document.getElementById("ndModal");
      if (!m) return;
      m.classList.remove("show");
      document.body.style.overflow = "";
    }
    function ndimbalAsk(){
      // Ici seulement on propose WA, mais la page explicative est d√©j√† l√†.
      const msg =
        "Bonjour DIGIY üëã\n" +
        "Je veux profiter de NDIMBAL (nuits offertes) et conna√Ætre les logements √©ligibles.\n" +
        "Mes dates : ____\n" +
        "Ma zone : ____\n" +
        "Mon budget : ____\n" +
        "Merci üôè";
      openWa(TEAM_WA, msg);
    }

    /* =========================
       RENDER
       + garantit qu‚ÄôAstou existe via PLACEBOT si Supabase ne le renvoie pas
    ========================= */
    function ensureAstou(list){
      const hasAstou = (list || []).some(x => norm(x.title) === norm("CHEZ ASTOU SALY"));
      if (hasAstou) return list;

      // PLACEBOT ASTOU (visible m√™me si pas encore publi√© dans Supabase)
      const astouBot = {
        title: "CHEZ ASTOU SALY",
        slug: "chez-astou-saly",
        address_label: "Saly",
        kind: "Villa ‚Ä¢ Direct propri√©taire",
        whatsapp: WHATSAPP_OVERRIDES_BY_SLUG["chez-astou-saly"] || TEAM_WA,
        cover: PHOTO_OVERRIDES_BY_SLUG["chez-astou-saly"] ||
          "https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&w=1400&q=80",
        desc: "üåô NDIMBAL actif ici : 2 nuits pay√©es = 3e offerte (Lun-Jeu)."
      };

      return [astouBot, ...(list || [])];
    }

    async function render(){
      grid.innerHTML = `<div class="bigmsg">Chargement des logements‚Ä¶</div>`;

      const [pinsRes, occMap] = await Promise.all([
        fetchLocPins(),
        fetchOccupancyToday()
      ]);

      if (!pinsRes.ok){
        grid.innerHTML = `
          <div class="bigmsg">
            ‚ùå Erreur Supabase : <b>${escapeHtml(pinsRes.error || "inconnue")}</b><br>
            üëâ Si tu vois ‚ÄúInvalid API key‚Äù, c‚Äôest une cl√©/URL qui ne matchent pas.
          </div>
        `;
        return;
      }

      // Base pins
      let pins = (pinsRes.rows || []).map(p => ({ ...p, kind: computeKind(p) }));

      // Force Astou pr√©sent m√™me si pas encore en DB
      pins = ensureAstou(pins);

      // Merge placebots (garniture)
      const merged = mergeNoDup(pins, PLACEBOTS, 9);

      // Filtres
      const filtered = applyFilters(merged);

      if (!filtered.length){
        grid.innerHTML = `
          <div class="bigmsg">
            Aucun r√©sultat avec ces filtres. Clique <b>Reset</b> puis relance.
          </div>
        `;
        return;
      }

      grid.innerHTML = filtered.map(p => cardTemplate(p, occMap)).join("");
    }

    /* =========================
       EVENTS
    ========================= */
    document.getElementById("btnSearch").addEventListener("click", render);
    document.getElementById("btnReset").addEventListener("click", ()=>{
      document.getElementById("q").value = "";
      document.getElementById("kind").value = "";
      render();
    });

    // Bouton NDIMBAL top
    const topNd = document.getElementById("btnNdimbalTop");
    if (topNd){
      topNd.addEventListener("click",(e)=>{
        e.preventDefault();
        openNdimbal();
      });
    }

    // Close modal
    document.addEventListener("keydown",(e)=>{
      if (e.key === "Escape") closeNdimbal();
    });

    ["q"].forEach(id=>{
      document.getElementById(id).addEventListener("keydown",(e)=>{
        if (e.key === "Enter") render();
      });
    });

    render();
  </script>

  <!-- =========================
       NDIMBAL MODAL (PAGE EXPLICATIVE IN-APP)
  ========================== -->
  <div class="ndModal" id="ndModal" aria-hidden="true">
    <div class="ndBackdrop" onclick="closeNdimbal()"></div>

    <div class="ndSheet" role="dialog" aria-modal="true" aria-label="NDIMBAL ‚Äî Nuits offertes">
      <div class="ndTop">
        <div class="ndIcon">üåô</div>
        <div class="ndHead">
          <div class="ndTitle2">NDIMBAL ‚Äî Nuits offertes</div>
          <div class="ndSub2">Moteur d‚Äô√©conomie de quartier ‚Ä¢ pas une commission ‚Ä¢ pas une taxe</div>
        </div>
        <button class="ndClose" type="button" onclick="closeNdimbal()">‚úï</button>
      </div>

      <div class="ndBody">
        <div class="ndCard">
          <div class="ndCardTitle">‚úÖ La r√®gle (simple)</div>
          <div class="ndCardLine"><b>2 nuits pay√©es = 3·µâ offerte</b> (du <b>lundi au jeudi</b>)</div>
          <div class="ndCardSmall">Objectif : te faire rester 1 nuit de plus ‚Üí tu consommes 1 jour de plus dans le quartier.</div>
        </div>

        <div class="ndGrid">
          <div class="ndCard">
            <div class="ndCardTitle">üí• Pourquoi c‚Äôest puissant ?</div>
            <div class="ndCardSmall">
              ‚Ä¢ Le client reste + longtemps<br>
              ‚Ä¢ Resto, march√©, taxi, sorties : le quartier gagne<br>
              ‚Ä¢ Le logement gagne en recommandations / bouche-√†-oreille<br>
              ‚Ä¢ La com est simple, WhatsApp-friendly
            </div>
          </div>

          <div class="ndCard">
            <div class="ndCardTitle">üè† Comment reconna√Ætre un logement NDIMBAL ?</div>
            <div class="ndCardSmall">
              Sur la carte logement, tu verras le badge :<br>
              <b>üåô NDIMBAL ‚Ä¢ Nuits offertes</b><br>
              et le bloc explicatif juste dessous.
            </div>
          </div>
        </div>

        <div class="ndCard ndHighlight">
          <div class="ndCardTitle">‚≠ê Exemple terrain</div>
          <div class="ndCardSmall">
            Tu viens 2 nuits (Lun-Jeu) ‚Üí la 3e est offerte.<br>
            Tu profites du s√©jour, et tu d√©penses une journ√©e de plus dans la zone.<br>
            <b>Retomb√©es √©normes</b> : c‚Äôest √ßa NDIMBAL.
          </div>
        </div>

        <div class="ndActions">
          <button class="ndBtn primary" type="button" onclick="closeNdimbal()">‚úÖ J‚Äôai compris</button>
          <button class="ndBtn ghost" type="button" onclick="ndimbalAsk()">üì≤ Demander les logements NDIMBAL</button>
        </div>

        <div class="ndFoot">
          DIGIY LOC ‚Äî NDIMBAL = s√©jour + long ‚Ä¢ quartier + vivant ‚ôæÔ∏è
        </div>
      </div>
    </div>
  </div>

  <style>
    /* ===== NDIMBAL MODAL premium ===== */
    .ndModal{position:fixed;inset:0;z-index:9999;display:none}
    .ndModal.show{display:block}
    .ndBackdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px)}
    .ndSheet{
      position:absolute;left:50%;top:50%;
      transform:translate(-50%,-50%);
      width:min(920px,92vw);
      background:radial-gradient(circle at top left,rgba(250,204,21,.14),rgba(3,7,18,.98));
      border:1px solid rgba(148,163,184,.35);
      border-radius:22px;
      box-shadow:0 25px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .ndTop{display:flex;align-items:center;gap:12px;padding:14px 14px;border-bottom:1px solid rgba(148,163,184,.22)}
    .ndIcon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,#facc15,#f97316);color:#111;font-weight:900;font-size:22px}
    .ndHead{flex:1;min-width:0}
    .ndTitle2{font-weight:950;font-size:18px;color:#fde68a}
    .ndSub2{font-weight:750;font-size:13px;color:#e5e7eb;opacity:.92}
    .ndClose{border:none;background:rgba(15,23,42,.65);color:#e5e7eb;border:1px solid rgba(148,163,184,.3);
      border-radius:12px;padding:8px 10px;font-weight:950;cursor:pointer}
    .ndBody{padding:14px}
    .ndGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px}
    @media(max-width:820px){.ndGrid{grid-template-columns:1fr}}
    .ndCard{
      background:rgba(2,6,23,.68);
      border:1px solid rgba(148,163,184,.22);
      border-radius:16px;
      padding:12px;
    }
    .ndHighlight{border-color:rgba(250,204,21,.38);background:rgba(250,204,21,.06)}
    .ndCardTitle{font-weight:950;color:#bbf7d0;margin-bottom:6px}
    .ndCardLine{font-weight:900;font-size:15px;color:#fff;line-height:1.4}
    .ndCardSmall{font-weight:650;font-size:13px;color:#e5e7eb;line-height:1.6;opacity:.95}
    .ndActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:14px}
    .ndBtn{
      border-radius:999px;padding:11px 14px;font-weight:950;cursor:pointer;border:1px solid rgba(148,163,184,.25);
      background:rgba(15,23,42,.6);color:#e5e7eb
    }
    .ndBtn.primary{background:linear-gradient(135deg,#facc15,#f97316);border-color:rgba(250,204,21,.5);color:#111}
    .ndBtn.ghost{background:rgba(22,163,74,.16);border-color:rgba(34,197,94,.55);color:#bbf7d0}
    .ndFoot{margin-top:10px;font-size:12px;color:#cbd5f5;font-weight:800;opacity:.9}
  </style>

</body>
</html>
