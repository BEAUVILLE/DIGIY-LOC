<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#052e16" />
  <title>DIGIY LOC ‚ôæÔ∏è ‚Äî Trouve ta location</title>
  <meta name="description" content="DIGIY LOC ‚Äî Trouve une location en 30 secondes. Paiement direct. 0% commission." />

  <style>
    :root{
      --bg:#022c22;--bg2:#065f46;--card:#062a18;
      --accent:#facc15;--text:#e5e7eb;--muted:#9ca3af;
      --danger:#fb7185;--ok:#22c55e;--line:rgba(148,163,184,.22);
      --glass:rgba(2,44,34,.35);
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --r:18px;
      --max:1120px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      color:var(--text);
      background:
        radial-gradient(circle at top,#16a34a22 0,transparent 55%),
        radial-gradient(circle at 15% 85%, rgba(250,204,21,.14) 0, transparent 55%),
        linear-gradient(135deg,var(--bg),var(--bg2));
      padding:18px 14px 42px;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--max);margin:0 auto}
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      margin:10px 0 14px;
    }
    .brand{display:flex;flex-direction:column;gap:6px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border:1px solid var(--line);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      border-radius:999px;
      width:max-content;
      box-shadow:0 10px 25px rgba(0,0,0,.18);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 18px rgba(250,204,21,.35)}
    h1{font-size:22px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13.5px;line-height:1.35;max-width:720px}
    .hint{margin-top:6px;color:rgba(229,231,235,.9);font-size:13px}
    .hint b{color:var(--accent)}

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .search{
      padding:14px;
      display:grid;
      grid-template-columns: 1.2fr .8fr .8fr .7fr auto;
      gap:10px;
      align-items:end;
    }
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:rgba(229,231,235,.85)}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,44,34,.38);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(156,163,175,.9)}
    .btn{
      padding:11px 14px;border-radius:14px;border:1px solid rgba(250,204,21,.45);
      background:linear-gradient(180deg, rgba(250,204,21,.22), rgba(250,204,21,.08));
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      transition:transform .08s ease, filter .12s ease;
      height:44px;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:translateY(1px)}
    .row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 14px;border-top:1px solid var(--line);
      color:var(--muted);font-size:13px;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,44,34,.26);
      padding:6px 10px;border-radius:999px;
      font-size:12.5px;color:rgba(229,231,235,.9);
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:12px;
    }

    /* ===== TOP 10 VITRINE ===== */
    .sectionTitle{
      margin:14px 0 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .sectionTitle h2{
      font-size:15px;
      font-weight:950;
      letter-spacing:.2px;
      color:rgba(229,231,235,.95);
      display:flex;align-items:center;gap:8px;
    }
    .sectionTitle .note{
      color:rgba(229,231,235,.75);
      font-size:12.5px;
    }
    .top10{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:12px;
    }

    .pin{
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,44,34,.25);
      border-radius:18px;
      overflow:hidden;
      transition:transform .12s ease, border-color .12s ease, filter .12s ease;
      min-height:285px;
    }
    .pin:hover{transform:translateY(-2px);border-color:rgba(250,204,21,.35);filter:brightness(1.03)}
    .cover{
      height:145px;
      background:
        radial-gradient(circle at 20% 20%, rgba(250,204,21,.15), transparent 45%),
        linear-gradient(135deg, rgba(34,197,94,.22), rgba(2,44,34,.35));
      position:relative;
    }
    .cover img{
      width:100%;height:100%;object-fit:cover;display:block;
      filter:saturate(1.05) contrast(1.02);
    }
    .ribbon{
      position:absolute;left:10px;top:10px;
      display:inline-flex;align-items:center;gap:6px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(2,44,34,.45);
      backdrop-filter: blur(8px);
      font-size:12px;color:rgba(229,231,235,.95);
    }
    .content{padding:12px 12px 12px}
    .title{
      font-size:15px;font-weight:950;letter-spacing:.2px;
      line-height:1.25;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
      margin-bottom:8px;
    }
    .meta{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      color:rgba(229,231,235,.9);
      font-size:13px;
    }
    .place{color:var(--muted);font-size:12.5px;margin-top:4px}
    .kpis{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      font-size:12px;color:rgba(229,231,235,.9);
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,44,34,.22);
      padding:6px 9px;border-radius:999px;
    }
    .price{
      font-weight:950;color:var(--accent);
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .cta{
      margin-top:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      color:rgba(229,231,235,.85);
      font-size:12.5px;
    }
    .go{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:950;
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(250,204,21,.35);
      background:rgba(250,204,21,.08);
    }

    /* petit bouton partner */
    .partnerRow{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12.5px;
      color:rgba(229,231,235,.85);
    }
    .partnerBtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:12px;
      border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.10);
      font-weight:900;
      white-space:nowrap;
    }

    .state{
      margin-top:14px;
      border:1px dashed rgba(148,163,184,.30);
      background:rgba(2,44,34,.18);
      border-radius:18px;
      padding:16px;
      color:rgba(229,231,235,.92);
    }
    .state p{color:var(--muted);margin-top:6px;line-height:1.4}
    .small{font-size:12.5px}
    .loader{
      display:inline-flex;align-items:center;gap:10px;
      color:rgba(229,231,235,.92);
    }
    .spin{
      width:18px;height:18px;border-radius:999px;
      border:2px solid rgba(229,231,235,.25);
      border-top-color:var(--accent);
      animation:rot .8s linear infinite;
    }
    @keyframes rot{to{transform:rotate(360deg)}}

    /* ===== VITRINE CHAUDE (terrain) ===== */
    .showcase{
      margin:14px 0 14px;
      border:1px solid var(--line);
      background:
        radial-gradient(circle at 20% 20%, rgba(250,204,21,.16), transparent 52%),
        radial-gradient(circle at 80% 20%, rgba(34,197,94,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:22px;
      padding:16px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:12px;
      box-shadow:var(--shadow);
    }
    .showTag{
      display:inline-flex;align-items:center;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(250,204,21,.35);
      background:rgba(250,204,21,.10);
      width:max-content;
      font-size:12.5px;font-weight:950;color:rgba(229,231,235,.95);
    }
    .showTitle{margin-top:10px;font-size:18px;font-weight:950;letter-spacing:.2px}
    .showTxt{margin-top:6px;color:rgba(229,231,235,.88);line-height:1.35;max-width:720px}
    .showMini{margin-top:10px;color:rgba(229,231,235,.75);font-size:12.5px}
    .showActions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .showBtn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(250,204,21,.45);
      background:linear-gradient(180deg, rgba(250,204,21,.22), rgba(250,204,21,.08));
      font-weight:950;
      cursor:pointer;
    }
    .showBtn.ghost{
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,44,34,.28);
      font-weight:900;
      color:rgba(229,231,235,.92);
    }
    .showCard{
      height:100%;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,44,34,.22);
      border-radius:18px;
      padding:12px;
      display:flex;flex-direction:column;justify-content:space-between;
      overflow:hidden;
    }
    .showCardTop{display:flex;gap:8px;flex-wrap:wrap}
    .miniPill{
      font-size:12px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,44,34,.22);
      padding:6px 9px;border-radius:999px;
      color:rgba(229,231,235,.9);
    }
    .showCardMid{text-align:left}
    .bigPrice{font-size:24px;font-weight:950;color:var(--accent);letter-spacing:.2px}
    .miniTxt{margin-top:2px;color:rgba(229,231,235,.75);font-size:12.5px}
    .showCardBot{display:flex;flex-direction:column;gap:6px;color:rgba(229,231,235,.8);font-size:12.5px}
    .miniLine{opacity:.95}

    @media (max-width: 980px){
      .search{grid-template-columns:1fr 1fr 1fr; gap:10px}
      .search .field:nth-child(4){grid-column:1/2}
      .search .field:nth-child(5){grid-column:2/4}
      .grid{grid-template-columns:repeat(2, minmax(0,1fr))}
      .top10{grid-template-columns:repeat(2, minmax(0,1fr))}
      .showcase{grid-template-columns:1fr}
    }
    @media (max-width: 620px){
      .top{flex-direction:column}
      .search{grid-template-columns:1fr}
      .btn{width:100%}
      .grid{grid-template-columns:1fr}
      .top10{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="badge">
          <span class="dot"></span>
          <div style="font-weight:950">DIGIY LOC ‚ôæÔ∏è</div>
          <div style="color:rgba(229,231,235,.75)">0% commission</div>
        </div>
        <h1>Trouve ta location. Simple. Rapide. Terrain.</h1>
        <div class="sub">
          Tu tapes une zone, tu vois les options, tu ouvres la fiche, et tu contactes.
          <br/>Paiement direct quand c‚Äôest pr√™t ‚Äî pas de d√©tour.
        </div>
        <div class="hint">Astuce : cherche ‚Äú<b>Saly</b>‚Äù, ‚Äú<b>Almadies</b>‚Äù, ‚Äú<b>Ngor</b>‚Äù, ‚Äú<b>Saint-Louis</b>‚Äù‚Ä¶</div>
      </div>
    </div>

    <!-- VITRINE (exemple terrain) -->
    <div class="showcase">
      <div class="showLeft">
        <div class="showTag">‚≠ê Vitrine du jour</div>
        <div class="showTitle">Chez Astou ‚Äî ‚Äúpropre, simple, accueil royal‚Äù</div>
        <div class="showTxt">
          Exemple de fiche en vitrine. Tu cliques, tu vois direct : photos, prix, contact, et la vibe.
        </div>
        <div class="showActions">
          <!-- ‚úÖ lien public -> go-pin.html -->
          <a class="showBtn" id="demoAstou" href="go-pin.html?slug=chez-astou-saly">üëÄ Voir ‚ÄúChez Astou‚Äù</a>
          <button class="showBtn ghost" id="btnFocusSearch">üîé Je cherche ma zone</button>
        </div>
        <div class="showMini">üí° Astuce : √©cris une zone (Saly, Almadies‚Ä¶) et laisse DIGIY LOC te guider.</div>
      </div>

      <div class="showRight">
        <div class="showCard">
          <div class="showCardTop">
            <div class="miniPill">0% commission</div>
            <div class="miniPill">Paiement direct</div>
          </div>
          <div class="showCardMid">
            <div class="bigPrice">30 000 FCFA</div>
            <div class="miniTxt">/ nuit (exemple)</div>
          </div>
          <div class="showCardBot">
            <div class="miniLine">üìç Saly ‚Ä¢ proche plage</div>
            <div class="miniLine">üë• 2‚Äì4 pers ‚Ä¢ üõèÔ∏è 1 ch</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ TOP 10 (premiers inscrits) -->
    <div class="sectionTitle">
      <h2>üèÜ Les 10 premiers inscrits (vitrine)</h2>
      <div class="note">Ils passent devant ‚Äî c‚Äôest la r√®gle du terrain.</div>
    </div>
    <div id="top10" class="top10"></div>

    <div class="card">
      <div class="search">
        <div class="field">
          <label for="q">O√π tu veux poser tes valises ?</label>
          <input id="q" placeholder="Ex: Saly, Dakar, Almadies, Ngor..." autocomplete="off" />
        </div>

        <div class="field">
          <label for="kind">Type</label>
          <select id="kind">
            <option value="">Tout</option>
            <option value="villa">Villa</option>
            <option value="appartement">Appartement</option>
            <option value="studio">Studio</option>
            <option value="chambre">Chambre</option>
            <option value="maison">Maison</option>
          </select>
        </div>

        <div class="field">
          <label for="guests">Personnes</label>
          <input id="guests" type="number" min="1" step="1" placeholder="Ex: 2" />
        </div>

        <div class="field">
          <label for="maxPrice">Budget / nuit (FCFA)</label>
          <input id="maxPrice" type="number" min="0" step="1000" placeholder="Ex: 30000" />
        </div>

        <button class="btn" id="btnSearch">üîé Chercher</button>
      </div>

      <div class="row">
        <div class="chips">
          <span class="chip">üìç Bas√© sur <b>go_pins</b></span>
          <span class="chip">üîó Carte ‚Üí <b>go-pin.html</b>?slug=‚Ä¶</span>
          <span class="chip">üîí Cockpit priv√© (inchang√©)</span>
        </div>
        <div id="countTxt">‚Äî</div>
      </div>
    </div>

    <div id="state" class="state" style="display:none"></div>
    <div id="grid" class="grid"></div>
  </div>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* =========================
       DIGIY LOC ‚Äî INDEX (PUBLIC)
       Source: go_pins
       Top 10 = premiers inscrits (created_at asc)
       Cartes -> go-pin.html?slug=...
       Aucun refactor cockpit
    ========================== */

    /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â */
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI
    const elQ = document.getElementById("q");
    const elKind = document.getElementById("kind");
    const elGuests = document.getElementById("guests");
    const elMaxPrice = document.getElementById("maxPrice");
    const btn = document.getElementById("btnSearch");
    const grid = document.getElementById("grid");
    const top10 = document.getElementById("top10");
    const state = document.getElementById("state");
    const countTxt = document.getElementById("countTxt");

    // Vitrine: focus search
    const btnFocusSearch = document.getElementById("btnFocusSearch");
    if (btnFocusSearch){
      btnFocusSearch.addEventListener("click", () => {
        elQ.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => elQ.focus(), 250);
      });
    }

    // Helpers
    const esc = (s) => (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

    const fmtFCFA = (n) => {
      const x = Number(n);
      if (!Number.isFinite(x) || x <= 0) return "";
      try { return x.toLocaleString("fr-FR") + " FCFA"; }
      catch { return String(x) + " FCFA"; }
    };

    const num = (v) => {
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    };

    function showState(kind, title, msg) {
      state.style.display = "block";
      const icon = kind === "loading" ? `<span class="spin"></span>` : (kind === "error" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è");
      const head = kind === "loading"
        ? `<div class="loader">${icon}<b>${esc(title)}</b></div>`
        : `<div style="font-weight:950;font-size:15px">${icon} ${esc(title)}</div>`;
      state.innerHTML = `${head}<p class="small">${esc(msg || "")}</p>`;
    }
    function hideState(){ state.style.display = "none"; state.innerHTML = ""; }

    // ‚úÖ partner url tol√©rant (n‚Äôexplose pas si colonne absente)
    function getPartnerUrl(p){
      const u =
        p.partner_url ||
        p.partner_link ||
        p.partner_page ||
        p.fiche_url ||
        p.fiche_partenaire_url ||
        p.wp_url ||
        p.website ||
        "";
      return (u && typeof u === "string") ? u.trim() : "";
    }

    function pinCard(p, rankLabel){
      const slug = p.slug ?? p.pin_slug ?? p.code ?? "";
      const title = p.title ?? p.name ?? p.label ?? "Location";
      const city = p.city ?? p.ville ?? "";
      const area = p.area ?? p.zone ?? p.neighborhood ?? "";
      const kind = p.kind ?? p.type ?? "";
      const guests = p.guests ?? p.max_guests ?? p.capacity ?? null;
      const bedrooms = p.bedrooms ?? p.rooms ?? p.chambres ?? null;

      // Prix nuit (tol√©rant)
      const price = p.price_per_night ?? p.night_price ?? p.price_night ?? p.price ?? p.prix ?? null;

      // Cover (tol√©rant)
      const cover = p.cover_url ?? p.cover ?? p.image_url ?? p.photo_url ?? p.photo ?? "";

      const place = [area, city].filter(Boolean).join(" ‚Ä¢ ");
      const ribbonTxt = rankLabel ? `üèÜ ${rankLabel}` : (kind ? kind : "Disponible");
      const href = slug ? `go-pin.html?slug=${encodeURIComponent(slug)}` : `go-pin.html`;

      const kpis = [];
      if (Number.isFinite(Number(bedrooms)) && Number(bedrooms) > 0) kpis.push(`üõèÔ∏è ${Number(bedrooms)} ch.`);
      if (Number.isFinite(Number(guests)) && Number(guests) > 0) kpis.push(`üë• ${Number(guests)} pers.`);
      if (place) kpis.push(`üìç ${place}`);

      const priceTxt = fmtFCFA(price);

      const partnerUrl = getPartnerUrl(p);
      const partnerBtn = partnerUrl
        ? `<a class="partnerBtn" href="${esc(partnerUrl)}" target="_blank" rel="noopener">üé• Fiche compl√®te</a>`
        : `<span style="color:rgba(229,231,235,.72)">Fiche partenaire : bient√¥t</span>`;

      return `
        <a class="pin" href="${href}">
          <div class="cover">
            ${cover ? `<img src="${esc(cover)}" alt="${esc(title)}" loading="lazy" />` : ``}
            <div class="ribbon">‚ú® ${esc(ribbonTxt)}</div>
          </div>
          <div class="content">
            <div class="title">${esc(title)}</div>
            <div class="meta">
              <div class="place">${place ? esc(place) : "Zone √† confirmer"}</div>
              <div class="price">${priceTxt ? esc(priceTxt) : "Prix √† voir"}</div>
            </div>

            <div class="kpis">
              ${kpis.slice(0,3).map(x => `<span class="kpi">${esc(x)}</span>`).join("")}
            </div>

            <div class="partnerRow">
              ${partnerBtn}
              <span class="go">Voir le PIN ‚ü∂</span>
            </div>
          </div>
        </a>
      `;
    }

    // ‚úÖ Top10 = created_at ASC (premiers inscrits)
    async function loadTop10(){
      top10.innerHTML = "";

      // On tente created_at, sinon fallback updated_at
      let { data, error } = await sb
        .from("go_pins")
        .select("*")
        .order("created_at", { ascending: true })
        .limit(10);

      if (error){
        const res2 = await sb
          .from("go_pins")
          .select("*")
          .order("updated_at", { ascending: true })
          .limit(10);

        data = res2.data || [];
        error = res2.error;
      }

      if (error){
        console.error(error);
        top10.innerHTML = `
          <div class="state" style="grid-column:1/-1">
            <div style="font-weight:950">‚ö†Ô∏è Vitrine Top 10 indisponible</div>
            <p class="small">Le public n‚Äôarrive pas √† lire go_pins. V√©rifie la RLS, puis recharge.</p>
          </div>
        `;
        return;
      }

      const arr = data || [];
      if (!arr.length){
        top10.innerHTML = `
          <div class="state" style="grid-column:1/-1">
            <div style="font-weight:950">‚ÑπÔ∏è Pas encore de fiches</div>
            <p class="small">D√®s que les proprios s‚Äôinscrivent, ils sortent ici automatiquement.</p>
          </div>
        `;
        return;
      }

      top10.innerHTML = arr.map((p, i) => pinCard(p, `Top ${i+1}`)).join("");
    }

    async function fetchPins(){
      hideState();
      grid.innerHTML = "";
      countTxt.textContent = "‚Äî";

      const q = (elQ.value || "").trim().toLowerCase();
      const kind = (elKind.value || "").trim().toLowerCase();
      const guestsNeed = Number(elGuests.value || 0);
      const maxPrice = Number(elMaxPrice.value || 0);

      showState("loading", "On cherche‚Ä¶", "On te ram√®ne les meilleures options du coin.");

      // ‚úÖ Query go_pins (public)
      let query = sb
        .from("go_pins")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(60);

      // Filtre texte (souple)
      if (q){
        query = query.or(
          [
            `title.ilike.%${q}%`,
            `name.ilike.%${q}%`,
            `city.ilike.%${q}%`,
            `ville.ilike.%${q}%`,
            `area.ilike.%${q}%`,
            `zone.ilike.%${q}%`,
            `neighborhood.ilike.%${q}%`,
            `slug.ilike.%${q}%`
          ].join(",")
        );
      }

      if (kind){
        query = query.or(`kind.eq.${kind},type.eq.${kind}`);
      }

      const { data, error } = await query;

      let list = data || [];
      if (error){
        // Fallback: sans OR (au cas o√π des colonnes n‚Äôexistent pas)
        const { data: data2, error: error2 } = await sb
          .from("go_pins")
          .select("*")
          .order("created_at", { ascending: false })
          .limit(60);

        if (error2){
          showState("error", "Oups‚Ä¶ √ßa bloque.", "Le public n‚Äôarrive pas √† lire go_pins. V√©rifie la RLS + colonnes, puis recharge.");
          console.error(error2);
          return;
        }
        list = data2 || [];
      }

      // Filtrage JS (safe)
      const filtered = (list || []).filter(p => {
        if (q){
          const txt = `${p.title||""} ${p.name||""} ${p.city||""} ${p.ville||""} ${p.area||""} ${p.zone||""} ${p.neighborhood||""} ${p.slug||""}`.toLowerCase();
          if (!txt.includes(q)) return false;
        }

        const k = (p.kind ?? p.type ?? "").toString().toLowerCase();
        if (kind && k && k !== kind) return false;

        const g = num(p.guests ?? p.max_guests ?? p.capacity ?? 0);
        if (Number.isFinite(guestsNeed) && guestsNeed > 0 && g > 0 && g < guestsNeed) return false;

        const price = num(p.price_per_night ?? p.night_price ?? p.price_night ?? p.price ?? p.prix ?? 0);
        if (Number.isFinite(maxPrice) && maxPrice > 0 && price > 0 && price > maxPrice) return false;

        return true;
      });

      renderPins(filtered);
    }

    function renderPins(list){
      hideState();
      const arr = list || [];
      countTxt.textContent = arr.length ? `${arr.length} r√©sultat(s)` : "0 r√©sultat";

      if (!arr.length){
        showState("info", "Rien pour l‚Äôinstant.", "Change la zone, enl√®ve un filtre, ou r√©essaie. Le terrain bouge vite.");
        grid.innerHTML = "";
        return;
      }

      grid.innerHTML = arr.map(p => pinCard(p, "")).join("");
    }

    // UX: Enter = search
    elQ.addEventListener("keydown", (e) => { if (e.key === "Enter") fetchPins(); });
    elGuests.addEventListener("keydown", (e) => { if (e.key === "Enter") fetchPins(); });
    elMaxPrice.addEventListener("keydown", (e) => { if (e.key === "Enter") fetchPins(); });
    btn.addEventListener("click", fetchPins);

    // Auto-load
    (async () => {
      await loadTop10();
      await fetchPins();
    })();
  </script>
</body>
</html>
