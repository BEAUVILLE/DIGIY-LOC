<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>DIGIY LOC ‚Äî Fiche logement</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#020617; --card:#0b1220; --line:#1f2937;
  --ink:#f9fafb; --muted:#cbd5f5;
  --gold:#facc15; --green:#22c55e; --soft:rgba(255,255,255,.04);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 520px at 15% -10%, rgba(250,204,21,.14), transparent 60%),
    radial-gradient(900px 520px at 90% 0%, rgba(34,197,94,.12), transparent 60%),
    var(--bg);
}
.wrap{max-width:980px;margin:0 auto;padding:14px}
.topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:6px 0 14px}
.back{
  display:inline-flex;gap:8px;align-items:center;
  padding:10px 12px;border-radius:12px;
  background:var(--soft);border:1px solid var(--line);
  color:var(--muted);text-decoration:none;font-weight:900;
}
.badge{
  border:1px solid rgba(250,204,21,.35);
  background:rgba(250,204,21,.12);
  color:#fde68a;
  padding:8px 12px;border-radius:999px;
  font-weight:950;font-size:.9rem;
}
.hero{
  border:1px solid var(--line);
  border-radius:20px;
  overflow:hidden;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
}
.cover{
  width:100%; height:340px; object-fit:cover; display:block;
  background:rgba(255,255,255,.06);
}
.content{padding:14px}
h1{margin:0 0 6px;font-size:1.85rem;letter-spacing:.2px}
.meta{color:var(--muted);font-weight:800}
.priceRow{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap;margin-top:10px}
.price{color:var(--gold);font-weight:1000;font-size:1.3rem}
.small{color:var(--muted);font-weight:800;font-size:.95rem}

.grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
@media (max-width: 860px){ .grid2{grid-template-columns:1fr} }

.card{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:18px;
  padding:14px;
}
.card h2{margin:0 0 10px;font-size:1.15rem}
.desc{color:rgba(203,213,245,.95);line-height:1.5}

.kpis{display:flex;gap:10px;flex-wrap:wrap}
.kpi{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:999px;
  padding:8px 10px;
  color:var(--muted);
  font-weight:900;
  font-size:.92rem;
}

.gallery{display:grid;grid-template-columns:repeat(3, 1fr);gap:10px}
@media (max-width: 700px){ .gallery{grid-template-columns:repeat(2, 1fr)} }
.gimg{
  width:100%; height:120px; object-fit:cover;
  border-radius:14px; border:1px solid var(--line);
  background:rgba(255,255,255,.06); cursor:pointer;
}
.videoWrap{
  position:relative; padding-top:56.25%;
  border-radius:16px; overflow:hidden;
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
}
.videoWrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{
  border:0;border-radius:14px;
  padding:13px 14px;
  font-weight:1000;
  cursor:pointer;
}
.btnPrimary{background:var(--green);color:#022c22}
.btnGhost{background:rgba(255,255,255,.03);border:1px solid var(--line);color:var(--muted)}
.btnGold{background:rgba(250,204,21,.14);border:1px solid rgba(250,204,21,.35);color:#fde68a}

.note{
  margin-top:10px;padding:10px 12px;border:1px solid var(--line);
  border-radius:12px;color:var(--muted);background:rgba(255,255,255,.03);
  display:none;white-space:pre-wrap;
}

.formRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width: 520px){ .formRow{grid-template-columns:1fr} }
.label{color:var(--muted);font-weight:900;font-size:.92rem;margin:8px 0 6px}
input{
  width:100%; padding:12px 12px;border-radius:12px;
  border:1px solid var(--line); background:rgba(0,0,0,.18); color:var(--ink);
  font-weight:800;
}
.summary{
  margin-top:10px; padding:10px 12px; border:1px solid var(--line);
  border-radius:12px; background:rgba(255,255,255,.03); color:var(--muted);
}

.lightbox{
  position:fixed;inset:0;background:rgba(0,0,0,.75);
  display:none;align-items:center;justify-content:center;padding:16px;
}
.lightbox img{
  max-width:95vw;max-height:85vh;border-radius:16px;
  border:1px solid rgba(255,255,255,.18);
}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <a class="back" href="index.html">‚Üê Retour</a>
    <div class="badge">Contact direct ‚Ä¢ 0% commission</div>
  </div>

  <div class="hero">
    <img id="cover" class="cover" alt="Logement">
    <div class="content">
      <h1 id="nom">Chargement‚Ä¶</h1>
      <div class="meta" id="meta"></div>

      <div class="priceRow">
        <div class="price" id="prix"></div>
        <div class="small" id="pricesPlus"></div>
      </div>

      <div class="actions">
        <button class="btn btnPrimary" id="btnCall">üìû Appeler</button>
        <button class="btn btnGhost" id="btnMail">‚úâÔ∏è Email</button>
        <button class="btn btnGhost" id="btnWa">üí¨ WhatsApp</button>
        <button class="btn btnGhost" id="btnMap">üìç Carte</button>
      </div>

      <div class="note" id="note"></div>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <h2>‚ú® Pr√©sentation</h2>
      <div class="desc" id="desc">‚Äî</div>

      <div style="height:12px"></div>
      <div class="kpis" id="kpis"></div>

      <div style="height:14px"></div>
      <h2>üì∏ Photos</h2>
      <div class="gallery" id="gallery"></div>

      <div style="height:14px"></div>
      <div id="videoBlock" style="display:none">
        <h2>üé• Vid√©o</h2>
        <div class="videoWrap">
          <iframe id="video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üìÖ Disponibilit√©s</h2>

      <div class="formRow">
        <div>
          <div class="label">Arriv√©e</div>
          <input id="inDate" type="date">
        </div>
        <div>
          <div class="label">D√©part</div>
          <input id="outDate" type="date">
        </div>
      </div>

      <div class="summary" id="summary">Choisis tes dates pour voir le total.</div>

      <div style="height:12px"></div>
      <h2>üí≥ Paiement (anti-lapin)</h2>
      <div class="desc">
        Pour bloquer la r√©servation, un <b>acompte</b> peut √™tre demand√©. √áa rassure tout le monde et √©vite les ‚Äúje viens / je viens pas‚Äù.
      </div>

      <div class="actions">
        <button class="btn btnGold" id="btnWave">üåä Payer acompte via Wave</button>
        <button class="btn btnGhost" id="btnRequest">‚úÖ Envoyer la demande</button>
      </div>

      <div style="height:12px"></div>
      <h2>üí∞ Suppl√©ments</h2>
      <div class="desc" id="fees">‚Äî</div>

      <div style="height:12px"></div>
      <h2>üõ°Ô∏è Transparence DIGIY</h2>
      <div class="desc">
        DIGIY LOC ne prend pas de commission. Paiement direct au propri√©taire.
      </div>
    </div>
  </div>
</div>

<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <img id="lbImg" alt="Photo">
</div>

<script>
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const id = new URLSearchParams(location.search).get("id");
const note = document.getElementById("note");

let LOG = null;
let calc = { nights:0, total:0, deposit:0 };

function showNote(t){
  note.style.display = "block";
  note.textContent = t;
}
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function money(n){ return Number(n||0).toLocaleString("fr-FR") + " FCFA"; }
function parsePhotos(v){
  if(!v) return [];
  if(Array.isArray(v)) return v.filter(Boolean);
  if(typeof v === "string"){
    try { return parsePhotos(JSON.parse(v)); } catch { return [v]; }
  }
  if(typeof v === "object"){
    if(Array.isArray(v.urls)) return v.urls.filter(Boolean);
    if(Array.isArray(v.photos)) return v.photos.filter(Boolean);
  }
  return [];
}
function toEmbedUrl(url){
  const u = String(url||"").trim();
  if(!u) return "";
  const yt = u.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([A-Za-z0-9_\-]+)/);
  if(yt && yt[1]) return "https://www.youtube.com/embed/" + yt[1];
  const vm = u.match(/vimeo\.com\/(\d+)/);
  if(vm && vm[1]) return "https://player.vimeo.com/video/" + vm[1];
  return u;
}
function openLightbox(src){
  document.getElementById("lbImg").src = src;
  document.getElementById("lightbox").style.display = "flex";
}
function closeLightbox(){ document.getElementById("lightbox").style.display = "none"; }

function statusAllowed(status){
  const s = String(status||"").toLowerCase();
  return ["actif","active","published","online"].includes(s);
}

function daysBetween(a,b){
  const da = new Date(a+"T00:00:00");
  const db = new Date(b+"T00:00:00");
  const diff = (db - da) / (1000*60*60*24);
  return Math.max(0, Math.floor(diff));
}

function recompute(){
  const inD = document.getElementById("inDate").value;
  const outD = document.getElementById("outDate").value;
  const summary = document.getElementById("summary");

  if(!LOG || !inD || !outD){
    summary.textContent = "Choisis tes dates pour voir le total.";
    calc = { nights:0, total:0, deposit:0 };
    return;
  }

  const nights = daysBetween(inD, outD);
  if(nights <= 0){
    summary.textContent = "Le d√©part doit √™tre apr√®s l‚Äôarriv√©e.";
    calc = { nights:0, total:0, deposit:0 };
    return;
  }

  const total = nights * Number(LOG.prix_nuit || 0);
  const pct = Number(LOG.deposit_percent || 30); // d√©faut 30%
  const deposit = Math.round(total * (pct/100));

  calc = { nights, total, deposit };

  summary.innerHTML =
    `‚úÖ <b>${nights}</b> nuit(s) ‚Ä¢ Total <b>${money(total)}</b> ‚Ä¢ Acompte (${pct}%) <b>${money(deposit)}</b>`;
}

(async()=>{
  const { data, error } = await SB
    .from("digiy_logements")
    .select("id,owner_id,proprietaire_phone,proprietaire_email,nom,adresse,ville,description,personnes_max,chambres,lits,salles_bain,prix_nuit,prix_semaine,prix_mois,frais_supplements,photo_url,video_url,photos_urls,status,created_at,wave_pay_link,deposit_percent")
    .eq("id", id)
    .single();

  if(error || !data){
    showNote("Logement introuvable.");
    return;
  }
  LOG = data;

  // Titre/meta
  document.getElementById("nom").textContent = data.nom || "Logement";
  document.getElementById("meta").textContent = [data.ville, data.adresse].filter(Boolean).join(" ‚Ä¢ ");

  // Cover + galerie (cover = photo_url ; galerie = photo_url + photos_urls)
  const cover = document.getElementById("cover");
  if(data.photo_url){
    cover.src = data.photo_url;
  }else{
    cover.style.height = "240px";
  }

  const gallery = document.getElementById("gallery");
  const urls = [data.photo_url, ...parsePhotos(data.photos_urls)].filter(Boolean);
  const uniq = [...new Set(urls)].slice(0, 15);
  if(uniq.length === 0){
    gallery.innerHTML = `<div class="desc">Photos √† venir.</div>`;
  }else{
    uniq.forEach(src=>{
      const img = document.createElement("img");
      img.className = "gimg";
      img.loading = "lazy";
      img.src = src;
      img.alt = "Photo";
      img.onclick = ()=>openLightbox(src);
      gallery.appendChild(img);
    });
  }

  // Vid√©o
  const embed = toEmbedUrl(data.video_url);
  if(embed){
    document.getElementById("video").src = embed;
    document.getElementById("videoBlock").style.display = "block";
  }

  // Prix
  document.getElementById("prix").textContent = money(data.prix_nuit) + " / nuit";
  const plus = [];
  if(data.prix_semaine) plus.push(money(data.prix_semaine) + " / semaine");
  if(data.prix_mois) plus.push(money(data.prix_mois) + " / mois");
  document.getElementById("pricesPlus").textContent = plus.join(" ‚Ä¢ ");

  // Description
  document.getElementById("desc").textContent = data.description || "‚Äî";

  // KPIs
  const k = document.getElementById("kpis");
  const addKpi = (t)=>{ const d=document.createElement("div"); d.className="kpi"; d.textContent=t; k.appendChild(d); };
  if(data.personnes_max) addKpi("üë• " + data.personnes_max + " pers.");
  if(data.chambres) addKpi("üõèÔ∏è " + data.chambres + " chambres");
  if(data.lits) addKpi("üõå " + data.lits + " lits");
  if(data.salles_bain) addKpi("üõÅ " + data.salles_bain + " sdb");

  // Suppl√©ments
  document.getElementById("fees").textContent = data.frais_supplements || "‚Äî";

  // Boutons contact (WhatsApp optionnel)
  const phoneRaw = String(data.proprietaire_phone || "");
  const phone = phoneRaw.replace(/\D/g,'');
  const email = String(data.proprietaire_email || "");

  document.getElementById("btnCall").onclick = ()=>{
    if(!statusAllowed(LOG.status)) return location.href = "https://pay.digiylyfe.com/loc";
    if(!phone) return showNote("Num√©ro non disponible pour le moment.");
    location.href = `tel:${phone}`;
  };

  document.getElementById("btnWa").onclick = ()=>{
    if(!statusAllowed(LOG.status)) return location.href = "https://pay.digiylyfe.com/loc";
    if(!phone) return showNote("WhatsApp non disponible pour le moment.");
    const inD = document.getElementById("inDate").value;
    const outD = document.getElementById("outDate").value;
    const msg = encodeURIComponent(
      `Bonjour, je vous contacte via DIGIY LOC pour "${LOG.nom}".` +
      (calc.nights ? `\nDates: ${inD} ‚Üí ${outD} (${calc.nights} nuits). Total: ${money(calc.total)}. Acompte: ${money(calc.deposit)}.` : "")
    );
    location.href = `https://wa.me/${phone}?text=${msg}`;
  };

  document.getElementById("btnMail").onclick = ()=>{
    if(!statusAllowed(LOG.status)) return location.href = "https://pay.digiylyfe.com/loc";
    if(!email) return showNote("Email non disponible pour le moment.");
    const inD = document.getElementById("inDate").value;
    const outD = document.getElementById("outDate").value;
    const subject = encodeURIComponent(`DIGIY LOC ‚Äî Demande r√©servation : ${LOG.nom}`);
    const body = encodeURIComponent(
      `Bonjour,\n\nJe vous contacte via DIGIY LOC pour "${LOG.nom}".\n` +
      (calc.nights ? `Dates: ${inD} ‚Üí ${outD} (${calc.nights} nuits)\nTotal: ${money(calc.total)}\nAcompte: ${money(calc.deposit)}\n\n` : "\n") +
      "Merci et √† bient√¥t."
    );
    location.href = `mailto:${email}?subject=${subject}&body=${body}`;
  };

  document.getElementById("btnMap").onclick = ()=>{
    const q = encodeURIComponent([data.nom, data.adresse, data.ville].filter(Boolean).join(" "));
    location.href = "https://www.google.com/maps/search/?api=1&query=" + q;
  };

  // Calendrier calc
  document.getElementById("inDate").addEventListener("change", recompute);
  document.getElementById("outDate").addEventListener("change", recompute);

  // Paiement Wave (lien par logement)
  document.getElementById("btnWave").onclick = ()=>{
    if(!statusAllowed(LOG.status)) return location.href = "https://pay.digiylyfe.com/loc";
    if(!calc.nights) return showNote("Choisis d‚Äôabord tes dates (arriv√©e + d√©part).");
    if(!LOG.wave_pay_link) return showNote("Lien Wave non configur√© pour ce logement (ajoute wave_pay_link).");

    // On ouvre le lien Wave (acompte recommand√© dans le message)
    // Pour du paiement ‚Äúexact‚Äù (montant auto), on passera par Wave Checkout API c√¥t√© serveur. :contentReference[oaicite:1]{index=1}
    showNote(`Acompte conseill√© : ${money(calc.deposit)}.\nApr√®s paiement, envoie la preuve au propri√©taire (WhatsApp/Email).`);
    window.open(LOG.wave_pay_link, "_blank");
  };

  // Envoyer la demande (sans forcer WhatsApp)
  document.getElementById("btnRequest").onclick = ()=>{
    if(!statusAllowed(LOG.status)) return location.href = "https://pay.digiylyfe.com/loc";
    if(!calc.nights) return showNote("Choisis d‚Äôabord tes dates (arriv√©e + d√©part).");

    showNote("‚úÖ Demande pr√™te. Tu peux appeler, email, ou WhatsApp avec les dates. (Acompte Wave recommand√© pour bloquer.)");
  };

  recompute();
})();
</script>
</body>
</html>
