<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>DIGIY LOC ‚Äî Fiche logement</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0b1020;
    --card:#020617;
    --card-soft:#020617;
    --accent:#facc15;
    --accent-soft:#f97316;
    --ink:#f9fafb;
    --muted:#9ca3af;
    --line:#1f2937;

    /* Pastel S√©n√©gal */
    --sn-green:#00853F;
    --sn-green-soft:#E8F5EC;
    --sn-green-deep:#064E3B;
  }
  *{box-sizing:border-box;}
  body{
    margin:0; padding:0;
    background:radial-gradient(circle at top,#111827 0,#020617 55%);
    color:var(--ink);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  }
  .app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;}
  header{padding:14px 16px;display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;}
  .brand{font-weight:900;font-size:18px;}
  .brand span{color:var(--accent);}
  .tag{font-size:11px;border-radius:999px;border:1px solid rgba(148,163,184,.6);padding:4px 10px;white-space:nowrap;color:var(--muted);}
  main{flex:1;padding:0 12px 16px;}

  .hero{
    background:linear-gradient(135deg,#111827,#020617);
    border-radius:18px;
    padding:16px;
    border:1px solid rgba(250,204,21,.4);
    display:grid;
    grid-template-columns:minmax(0,1.3fr) minmax(0,1fr);
    gap:16px;
    align-items:flex-start;
    box-shadow:0 20px 40px rgba(0,0,0,.7);
    margin-bottom:16px;
  }
  @media(max-width:900px){ .hero{grid-template-columns:1fr;} }
  .hero h1{margin:0 0 6px;font-size:22px;}
  .hero p{margin:0 0 8px;font-size:13px;color:var(--muted);}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
  .chip{font-size:11px;border-radius:999px;border:1px solid rgba(148,163,184,.6);padding:4px 8px;color:var(--muted);}

  .hero-media{margin-top:10px;}
  .hero-photo{
    width:100%;max-height:220px;border-radius:14px;object-fit:cover;display:block;border:1px solid #1f2937;
  }
  .hero-caption{margin-top:4px;font-size:11px;color:#e5e7eb;font-weight:500;}

  .price-block{
    background:#020617;border-radius:14px;border:1px solid #1f2937;padding:10px 12px;font-size:13px;
  }
  .price-block h2{margin:0 0 4px;font-size:14px;color:var(--accent);}
  .tarifs{display:flex;flex-direction:column;gap:4px;margin:6px 0;}
  .tarifs span{display:flex;justify-content:space-between;}

  .cta-col{display:flex;flex-direction:column;gap:8px;margin-top:14px;}
  .btn{
    border:none;border-radius:999px;padding:10px 12px;font-size:14px;font-weight:800;cursor:pointer;
    display:flex;justify-content:center;align-items:center;gap:8px;text-decoration:none;
  }
  .btn-wa{background:#16a34a;color:#ecfdf3;}
  .btn-call{background:#0f172a;color:#e5e7eb;border:1px solid #1f2937;}
  .btn-email{background:#111827;color:#e5e7eb;border:1px solid #334155;}
  .btn-video{background:#111827;color:#e5e7eb;border:1px solid #334155;font-size:13px;}
  .btn-wave{background:#022c22;color:#bbf7d0;border:1px solid #22c55e;}

  .layout{display:grid;grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);gap:12px;}
  @media(max-width:900px){ .layout{grid-template-columns:1fr;} }

  .card{background:var(--card);border-radius:16px;border:1px solid var(--line);box-shadow:0 16px 32px rgba(0,0,0,.6);padding:12px;}
  .card h2{margin:0 0 4px;font-size:16px;}
  .card small{font-size:12px;color:var(--muted);}

  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
  @media(max-width:640px){ .form-grid{grid-template-columns:1fr;} }

  .field label{display:block;font-size:11px;color:#fff;margin-bottom:2px;font-weight:700;}
  .field input,.field select{
    width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);
    background:#020617;color:#f9fafb;font-size:13px;font-weight:700;
  }
  .field input[type="date"]{color-scheme:dark;}

  .summary{margin-top:10px;font-size:14px;color:#dcfce7;}
  .summary strong{color:var(--accent-soft);}

  footer{padding:8px 14px 14px;font-size:11px;color:var(--muted);text-align:center;}

  .inline-link{color:var(--accent-soft);text-decoration:none;}
  .inline-link:hover{text-decoration:underline;}

  .wave-card{
    margin-top:14px;padding:16px;border-radius:16px;background:#0f172a;border:2px solid #22c55e;
    box-shadow:0 0 22px rgba(34,197,94,0.28);
  }
  .pay-number{font-size:22px;font-weight:950;color:#22c55e;letter-spacing:1px;}
  .pay-note{font-size:13px;font-weight:800;color:#22c55e;}

  .note{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(148,163,184,.35);
    background:rgba(255,255,255,.04);
    color:#e5e7eb;
    display:none;
    white-space:pre-wrap;
  }

  /* vid√©o embed */
  .videoWrap{
    margin-top:10px;
    border-radius:14px;
    overflow:hidden;
    border:1px solid #334155;
    background:#0b1020;
    display:none;
  }
  .videoWrap iframe{width:100%;height:260px;border:0;display:block;}
</style>
</head>

<body>
<div class="app">
  <header>
    <div class="brand" id="brand">‚Äî <span>DIGIY LOC</span></div>
    <div class="tag" id="tag">Chargement‚Ä¶</div>
  </header>

  <main>
    <section class="hero">
      <div>
        <h1 id="title">Chargement‚Ä¶</h1>
        <p id="pitch">‚Äî</p>

        <div class="chips" id="chips"></div>

        <div class="hero-media">
          <img id="heroImg" src="" alt="Photo logement" class="hero-photo">
          <div class="hero-caption" id="caption">‚Äî</div>

          <div class="videoWrap" id="videoWrap">
            <iframe id="videoFrame" allow="autoplay; encrypted-media" allowfullscreen></iframe>
          </div>
        </div>
      </div>

      <div>
        <div class="price-block">
          <h2>Tarifs</h2>
          <div class="tarifs" id="tarifs"></div>
          <div style="font-size:11px;margin-top:4px;color:var(--muted);" id="tarifNote"></div>
        </div>

        <div class="wave-card" id="waveCard">
          <div style="font-size:18px;font-weight:950;color:#fff;margin-bottom:8px;">
            üí≥ Paiement direct propri√©taire ‚Äî Wave
          </div>
          <div class="pay-number" id="waveNumber">‚Äî</div>
          <div class="pay-note">‚úî √Ä utiliser dans votre application Wave</div>
          <div style="margin-top:10px;font-size:14px;font-weight:800;color:#fff;">
            Propri√©taire : <span id="ownerName">‚Äî</span>
          </div>
        </div>

        <div class="cta-col">
          <a class="btn btn-wa" id="btnWa" style="display:none">üí¨ R√©server par WhatsApp</a>
          <a class="btn btn-call" id="btnCall" style="display:none">üìû Appeler le propri√©taire</a>
          <a class="btn btn-email" id="btnEmail" style="display:none">‚úâÔ∏è √âcrire par email</a>
          <button class="btn btn-wave" id="btnWave" type="button" style="display:none">üåä Paiement Wave (acompte)</button>
          <a class="btn btn-video" id="btnVideo" href="#" target="_blank" rel="noopener" style="display:none">üé• Voir la vid√©o</a>
        </div>

        <div class="note" id="note"></div>
      </div>
    </section>

    <section class="layout">
      <article class="card" style="background:linear-gradient(135deg,var(--sn-green-soft),rgba(15,23,42,0.98));border:1px solid rgba(0,133,63,0.65);">
        <h2>R√©server</h2>
        <small>Choisis tes dates, puis contacte le propri√©taire (WhatsApp / appel / email).</small>

        <div class="form-grid">
          <div class="field">
            <label>Date d'arriv√©e</label>
            <input type="date" id="dateIn">
          </div>
          <div class="field">
            <label>Date de d√©part</label>
            <input type="date" id="dateOut">
          </div>
          <div class="field">
            <label>Nombre de personnes</label>
            <select id="guests">
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            </select>
          </div>
          <div class="field">
            <label>Votre nom</label>
            <input type="text" id="clientName" placeholder="Votre nom">
          </div>
          <div class="field">
            <label>Votre t√©l√©phone</label>
            <input type="tel" id="clientPhone" placeholder="+221 ...">
          </div>
          <div class="field">
            <label>Message (optionnel)</label>
            <input type="text" id="clientMsg" placeholder="Ex: arriv√©e tard / besoin lit b√©b√©‚Ä¶">
          </div>
        </div>

        <div class="summary" id="summary">
          S√©lectionnez vos dates pour voir le nombre de nuits et une estimation.
        </div>
      </article>

      <article class="card">
        <h2>Infos</h2>
        <small>Contact direct, 0% commission.</small>

        <div style="margin-top:10px;font-size:13px;line-height:1.7;color:#e5e7eb" id="infos">
          ‚Äî
        </div>
      </article>
    </section>
  </main>

  <footer id="footer">‚Äî</footer>
</div>

<script>
/* SUPABASE */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const SB = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const id = new URLSearchParams(location.search).get("id");

/* UI */
const note = document.getElementById("note");
function showNote(t){ note.style.display="block"; note.textContent=t; }
function money(n){ return Number(n||0).toLocaleString("fr-FR") + " F"; }
function cleanPhone(p){ return String(p||"").replace(/\D/g,""); }
function nightsBetween(a,b){
  if(!a || !b) return 0;
  const d1 = new Date(a+"T00:00:00");
  const d2 = new Date(b+"T00:00:00");
  const diff = (d2 - d1) / (1000*60*60*24);
  return diff>0 ? Math.floor(diff) : 0;
}

/* Vid√©o helpers */
function toEmbedUrl(url){
  const u = String(url||"").trim();
  if(!u) return "";
  // YouTube
  const yt = u.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([A-Za-z0-9_\-]+)/);
  if(yt && yt[1]) return "https://www.youtube.com/embed/" + yt[1];
  // Vimeo
  const vm = u.match(/vimeo\.com\/(\d+)/);
  if(vm && vm[1]) return "https://player.vimeo.com/video/" + vm[1];
  // Google Drive file
  const gd = u.match(/drive\.google\.com\/file\/d\/([^/]+)/);
  if(gd && gd[1]) return "https://drive.google.com/file/d/" + gd[1] + "/preview";
  return "";
}

let LOG=null;

function updateSummary(){
  if(!LOG) return;
  const dIn = document.getElementById("dateIn").value;
  const dOut = document.getElementById("dateOut").value;
  const g = Number(document.getElementById("guests").value || 1);
  const n = nightsBetween(dIn, dOut);
  const sum = document.getElementById("summary");

  if(!n){
    sum.innerHTML = "S√©lectionnez vos dates pour voir le nombre de nuits et une estimation.";
    return;
  }
  const total = n * Number(LOG.prix_nuit || 0);
  sum.innerHTML =
    `S√©jour de <strong>${n}</strong> nuit(s) ‚Ä¢ <strong>${g}</strong> personne(s). ` +
    `Estimation : <strong>${money(total)}</strong> (tarif nuit).`;
}

(async()=>{
  if(!id){ showNote("ID logement manquant."); return; }

  const { data, error } = await SB
    .from("digiy_logements")
    .select("id,nom,ville,adresse,description,personnes_max,chambres,lits,salles_bain,prix_nuit,prix_semaine,prix_mois,frais_supplements,photo_url,video_url,photos_urls,proprietaire_phone,proprietaire_email,status,wave_pay_link,deposit_percent")
    .eq("id", id)
    .single();

  if(error || !data){ showNote("Logement introuvable."); return; }
  LOG = data;

  // Header
  document.getElementById("brand").innerHTML = `${data.nom || "Logement"} ‚Äî <span>DIGIY LOC</span>`;
  const tagBits = [
    data.ville ? `üìç ${data.ville}` : null,
    data.personnes_max ? `${data.personnes_max} personnes max` : null,
    data.adresse ? `‚Ä¢ ${data.adresse}` : null
  ].filter(Boolean).join(" ¬∑ ");
  document.getElementById("tag").textContent = tagBits || "Contact direct propri√©taire";

  // Title + pitch
  document.getElementById("title").textContent = `${data.nom || "Logement"} ‚Äî ${data.ville || ""}`.trim();
  document.getElementById("pitch").textContent = data.description || "‚Äî";

  // Chips
  const chips = document.getElementById("chips");
  const addChip = (t)=>{ const s=document.createElement("span"); s.className="chip"; s.textContent=t; chips.appendChild(s); };
  if(data.personnes_max) addChip(`${data.personnes_max} pers max`);
  if(data.chambres) addChip(`${data.chambres} chambre(s)`);
  if(data.lits) addChip(`${data.lits} lit(s)`);
  if(data.salles_bain) addChip(`${data.salles_bain} sdb`);
  addChip("R√©servation directe propri√©taire");
  addChip("0% commission DIGIY");

  // Photo (si pas de photo_url, fallback sur ta photo DIGIY existante)
  const FALLBACK_PHOTO = "https://digiylyfe.com/wp-content/uploads/2025/06/042-BAPTISTE.png";
  const heroImg = document.getElementById("heroImg");
  heroImg.src = data.photo_url || FALLBACK_PHOTO;
  document.getElementById("caption").textContent = `Vue du logement ‚Äî ${data.ville || "DIGIY LOC"}`;

  // Tarifs
  const tarifs = document.getElementById("tarifs");
  const row = (label, val)=> `<span><span>${label}</span><strong>${val}</strong></span>`;
  tarifs.innerHTML = [
    row("Nuit :", data.prix_nuit ? money(data.prix_nuit) : "‚Äî"),
    row("Semaine :", data.prix_semaine ? money(data.prix_semaine) : "‚Äî"),
    row("Mois :", data.prix_mois ? money(data.prix_mois) : "‚Äî"),
  ].join("");

  document.getElementById("tarifNote").textContent =
    data.frais_supplements ? `‚ö° ${data.frais_supplements}` : "‚ö° Conditions √† confirmer avec le propri√©taire.";

  // Vid√©o embed + bouton
  const embed = toEmbedUrl(data.video_url);
  const videoWrap = document.getElementById("videoWrap");
  const videoFrame = document.getElementById("videoFrame");
  const btnVideo = document.getElementById("btnVideo");
  if(embed){
    videoFrame.src = embed;
    videoWrap.style.display = "block";
  }
  if(data.video_url){
    btnVideo.href = data.video_url;
    btnVideo.style.display = "flex";
  }

  // Contacts (WhatsApp optionnel)
  const phone = cleanPhone(data.proprietaire_phone);
  const email = String(data.proprietaire_email || "").trim();

  const btnWa = document.getElementById("btnWa");
  const btnCall = document.getElementById("btnCall");
  const btnEmail = document.getElementById("btnEmail");

  if(phone){
    btnCall.style.display = "flex";
    btnCall.href = "tel:+" + phone;

    btnWa.style.display = "flex";
    btnWa.href = "#";
    btnWa.addEventListener("click", (e)=>{
      e.preventDefault();
      const dIn = document.getElementById("dateIn").value;
      const dOut = document.getElementById("dateOut").value;
      const g = document.getElementById("guests").value;
      const name = document.getElementById("clientName").value.trim() || "Client";
      const tel = document.getElementById("clientPhone").value.trim() || "Non communiqu√©";
      const msgOpt = document.getElementById("clientMsg").value.trim();

      const n = nightsBetween(dIn, dOut);
      const total = n ? (n * Number(LOG.prix_nuit||0)) : 0;
      const pct = Number(LOG.deposit_percent||30);
      const deposit = total ? Math.round(total * pct/100) : 0;

      let txt = `Bonjour, je souhaite r√©server "${LOG.nom}" √† ${LOG.ville || ""} via DIGIY LOC.\n`;
      txt += `- Nom: ${name}\n- T√©l√©phone: ${tel}\n- Personnes: ${g}\n`;
      if(dIn && dOut) txt += `- Dates: du ${dIn} au ${dOut} (${n} nuit(s))\n`;
      if(total) txt += `- Estimation: ${money(total)} (tarif nuit)\n- Acompte conseill√© (${pct}%): ${money(deposit)}\n`;
      if(msgOpt) txt += `- Message: ${msgOpt}\n`;
      txt += `Merci de me confirmer la disponibilit√©.`;

      const url = "https://wa.me/" + phone + "?text=" + encodeURIComponent(txt);
      window.open(url, "_blank");
    });
  }else{
    btnWa.style.display = "none";
    btnCall.style.display = "none";
  }

  if(email){
    btnEmail.style.display = "flex";
    btnEmail.href = "#";
    btnEmail.addEventListener("click", (e)=>{
      e.preventDefault();
      const subject = encodeURIComponent(`DIGIY LOC ‚Äî Demande r√©servation : ${LOG.nom}`);
      const body = encodeURIComponent(`Bonjour,\n\nJe vous contacte via DIGIY LOC pour "${LOG.nom}".\n\nMerci.`);
      window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
    });
  }

  // Wave
  // - affichage num√©ro Wave = proprietaire_phone par d√©faut
  // - bouton Wave = wave_pay_link si tu l‚Äôajoutes en DB (recommand√©)
  const waveNumber = document.getElementById("waveNumber");
  waveNumber.textContent = data.proprietaire_phone ? data.proprietaire_phone : "Wave non configur√©";

  document.getElementById("ownerName").textContent = "Propri√©taire DIGIY";

  const btnWave = document.getElementById("btnWave");
  if(data.wave_pay_link){
    btnWave.style.display = "flex";
    btnWave.addEventListener("click", ()=>{
      const dIn = document.getElementById("dateIn").value;
      const dOut = document.getElementById("dateOut").value;
      const n = nightsBetween(dIn, dOut);
      if(!n) return showNote("Choisis tes dates d‚Äôabord (arriv√©e + d√©part).");

      const total = n * Number(LOG.prix_nuit || 0);
      const pct = Number(LOG.deposit_percent||30);
      const deposit = Math.round(total * pct/100);

      showNote(`Acompte conseill√© : ${money(deposit)}.\nApr√®s paiement, envoie la preuve au propri√©taire (WhatsApp / email).`);
      window.open(data.wave_pay_link, "_blank");
    });
  }else{
    btnWave.style.display = "none";
  }

  // Infos bloc
  const infos = document.getElementById("infos");
  const li = (t)=> `<div>‚Ä¢ ${t}</div>`;
  infos.innerHTML = [
    data.adresse ? li(`Adresse : ${data.adresse}`) : "",
    data.personnes_max ? li(`Capacit√© : ${data.personnes_max} personnes max`) : "",
    data.frais_supplements ? li(`Suppl√©ments : ${data.frais_supplements}`) : li("Suppl√©ments : √† confirmer"),
    li("Paiement direct propri√©taire (Wave recommand√©)"),
    li("0% commission DIGIY LOC"),
  ].join("");

  // footer
  document.getElementById("footer").textContent =
    `${data.nom || "Logement"} ‚Äî ${data.ville || ""} ¬∑ DIGIY LOC ¬∑ Contact direct`;

  // calendrier calc
  ["dateIn","dateOut","guests"].forEach(id=> document.getElementById(id).addEventListener("change", updateSummary));
  updateSummary();
})();
</script>
</body>
</html>
